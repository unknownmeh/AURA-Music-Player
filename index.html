<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<title>AURA ‚Äî Music Player</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

:root{
  --bg:#080810;
  --surface:rgba(14,14,26,0.92);
  --card:#1a1a2e;
  --border:rgba(255,255,255,0.07);
  --accent:#a78bfa;
  --accent2:#f472b6;
  --accent3:#38bdf8;
  --glow:rgba(167,139,250,0.4);
  --text:#f1f0ff;
  --muted:rgba(241,240,255,0.45);
  --dim:rgba(241,240,255,0.22);
  --white:#ffffff;
}

html,body{
  width:100%;height:100%;
  background:var(--bg);
  color:var(--text);
  font-family:'Syne',sans-serif;
  overflow:hidden;
  -webkit-user-select:none;user-select:none;
  -webkit-tap-highlight-color:transparent;
  touch-action:manipulation;
}

/* ‚ïê‚ïê‚ïê BACKGROUND ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.bg-layer{position:fixed;inset:0;pointer-events:none;z-index:0;overflow:hidden}
.bg-orb{position:absolute;border-radius:50%;filter:blur(90px);opacity:0;transition:opacity 1.5s}
.orb1{width:600px;height:600px;background:radial-gradient(circle,rgba(167,139,250,.22)0%,transparent 70%);top:-200px;left:-150px}
.orb2{width:500px;height:500px;background:radial-gradient(circle,rgba(244,114,182,.18)0%,transparent 70%);bottom:-150px;right:-100px}
.orb3{width:350px;height:350px;background:radial-gradient(circle,rgba(56,189,248,.14)0%,transparent 70%);top:40%;left:50%;transform:translate(-50%,-50%)}
.bg-orb.on{opacity:1}
.bg-grid{position:absolute;inset:0;background-image:linear-gradient(rgba(255,255,255,.015)1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,.015)1px,transparent 1px);background-size:52px 52px}

/* ‚ïê‚ïê‚ïê SPLASH ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
#splash{
  position:fixed;inset:0;z-index:200;
  display:flex;align-items:center;justify-content:center;
  background:var(--bg);
  transition:opacity .6s,visibility .6s;
  padding:env(safe-area-inset-top,16px) 20px env(safe-area-inset-bottom,16px)
}
#splash.gone{opacity:0;visibility:hidden;pointer-events:none}

.sp-card{
  width:min(420px,100%);
  background:rgba(14,14,26,.96);
  backdrop-filter:blur(40px);
  border:1px solid rgba(167,139,250,.22);
  border-radius:28px;
  padding:clamp(24px,5vw,42px) clamp(18px,5vw,38px);
  text-align:center;
  box-shadow:0 0 0 1px rgba(255,255,255,.04) inset,0 32px 80px rgba(0,0,0,.7),0 0 70px rgba(167,139,250,.1);
  display:flex;flex-direction:column;align-items:center
}
.sp-icon{font-size:clamp(44px,10vw,62px);line-height:1;margin-bottom:14px;filter:drop-shadow(0 0 22px rgba(167,139,250,.7));animation:fl 4s ease-in-out infinite}
.sp-logo{font-size:10px;font-weight:700;letter-spacing:5px;color:var(--accent);text-transform:uppercase;margin-bottom:10px}
.sp-title{font-size:clamp(20px,5vw,26px);font-weight:800;letter-spacing:-.5px;margin-bottom:8px}
.sp-sub{font-family:'DM Mono',monospace;font-size:clamp(11px,2.5vw,12px);color:var(--muted);line-height:1.75;margin-bottom:24px}
.sp-sub b{color:var(--accent);font-weight:400}

.sp-btn-main{
  width:100%;padding:clamp(13px,3vw,16px) 20px;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  border:none;border-radius:14px;
  font-family:'Syne',sans-serif;font-size:clamp(12px,3vw,14px);font-weight:700;letter-spacing:1.5px;
  color:#fff;text-transform:uppercase;cursor:pointer;
  box-shadow:0 8px 28px rgba(167,139,250,.4);
  transition:all .25s;display:flex;align-items:center;justify-content:center;gap:9px;
  margin-bottom:10px
}
.sp-btn-main:hover{transform:translateY(-2px);box-shadow:0 12px 36px rgba(167,139,250,.55)}
.sp-btn-main:active{transform:scale(.97)}
.sp-btn-sub{
  width:100%;padding:clamp(10px,2.5vw,13px) 20px;
  background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:12px;
  font-family:'Syne',sans-serif;font-size:clamp(10px,2.5vw,12px);font-weight:600;letter-spacing:1.5px;
  color:var(--muted);text-transform:uppercase;cursor:pointer;
  transition:all .2s;display:flex;align-items:center;justify-content:center;gap:8px;
  margin-bottom:14px
}
.sp-btn-sub:hover{background:rgba(167,139,250,.1);border-color:rgba(167,139,250,.3);color:var(--accent)}
.sp-note{font-family:'DM Mono',monospace;font-size:10px;color:var(--dim)}
.sp-btns{width:100%}

.sp-loading{display:none;flex-direction:column;align-items:center;gap:12px;width:100%}
.sp-loading.show{display:flex}
.sp-ring{width:42px;height:42px;border:3px solid rgba(167,139,250,.2);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
.sp-txt{font-family:'DM Mono',monospace;font-size:11px;color:var(--muted);letter-spacing:1px}
.sp-cnt{font-size:11px;color:var(--accent);font-family:'DM Mono',monospace}

/* ‚ïê‚ïê‚ïê APP WRAPPER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.app{
  position:relative;z-index:1;
  width:100vw;height:100vh;
  display:flex;align-items:center;justify-content:center;
  padding:env(safe-area-inset-top,0) 8px env(safe-area-inset-bottom,0);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PLAYER CARD ‚Äî RESPONSIVE (#1)
   Uses container queries for precise sizing
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.player-card{
  position:relative;
  width:min(390px, 100%);
  max-height:calc(100vh - env(safe-area-inset-top,0px) - env(safe-area-inset-bottom,0px) - 16px);
  overflow-y:auto;overflow-x:hidden;
  scrollbar-width:none;
  background:var(--surface);
  backdrop-filter:blur(40px);
  border:1px solid var(--border);
  border-radius:22px;
  box-shadow:0 0 0 1px rgba(255,255,255,.04) inset,0 24px 60px rgba(0,0,0,.6),0 0 50px rgba(167,139,250,.05);
  transition:box-shadow .6s;
  padding-bottom:max(16px, env(safe-area-inset-bottom,0px));
  container-type:inline-size;
}
.player-card::-webkit-scrollbar{display:none}
.player-card.playing{box-shadow:0 0 0 1px rgba(255,255,255,.05) inset,0 24px 60px rgba(0,0,0,.7),0 0 70px rgba(167,139,250,.14)}

/* ‚Äî HEADER ‚Äî */
.hd{
  display:flex;align-items:center;justify-content:space-between;
  padding:clamp(12px,3cqi,18px) clamp(14px,4cqi,22px) 10px;
  gap:8px;
}
.logo{font-size:clamp(9px,2.5cqi,11px);font-weight:700;letter-spacing:4px;color:var(--accent);text-transform:uppercase;opacity:.9;flex-shrink:0}

.folder-pill{
  display:none;align-items:center;gap:5px;
  background:rgba(56,189,248,.1);border:1px solid rgba(56,189,248,.28);
  border-radius:20px;padding:4px 10px;
  font-family:'DM Mono',monospace;font-size:clamp(7px,2cqi,9px);letter-spacing:1px;color:var(--accent3);
  max-width:clamp(80px,20cqi,110px);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
}
.folder-pill.show{display:flex}
.fp-dot{width:5px;height:5px;border-radius:50%;background:var(--accent3);flex-shrink:0;animation:blink 2s ease-in-out infinite}

.q-btn{
  display:flex;align-items:center;gap:5px;
  background:rgba(255,255,255,.05);border:1px solid var(--border);
  border-radius:20px;padding:5px 11px;cursor:pointer;
  font-family:'Syne',sans-serif;font-size:clamp(9px,2.5cqi,11px);font-weight:600;letter-spacing:1.5px;
  color:var(--muted);text-transform:uppercase;transition:all .25s;flex-shrink:0;
}
.q-btn:hover,.q-btn.on{background:rgba(167,139,250,.15);border-color:rgba(167,139,250,.4);color:var(--accent)}

/* ‚Äî ARTWORK ‚Äî */
.art-wrap{
  position:relative;
  margin:0 clamp(14px,4cqi,20px) 4px;
  border-radius:16px;overflow:hidden;
  width:calc(100% - clamp(28px,8cqi,40px));
  aspect-ratio:1/1;
  background:var(--card);
  box-shadow:0 12px 40px rgba(0,0,0,.5);
  flex-shrink:0;
}
.art-wrap::after{content:'';position:absolute;inset:0;border-radius:16px;border:1px solid rgba(255,255,255,.08);pointer-events:none}
.art-bg{position:absolute;inset:0;background:linear-gradient(135deg,#1a1a3e 0%,#0d0d22 50%,#1a0d2e 100%)}
.art-ph{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px}
.art-note{font-size:clamp(36px,10cqi,54px);line-height:1;filter:drop-shadow(0 0 20px rgba(167,139,250,.6));animation:fl 4s ease-in-out infinite}
.art-hint{font-size:clamp(9px,2.5cqi,11px);letter-spacing:2px;font-weight:600;color:var(--dim);text-transform:uppercase;text-align:center;padding:0 14px}
.art-pulse{position:absolute;inset:0;border-radius:16px;background:radial-gradient(circle at 50% 50%,rgba(167,139,250,.1),transparent 70%);opacity:0;transition:opacity .6s}
.playing .art-pulse{opacity:1;animation:pr 2s ease-in-out infinite}

/* ‚Äî TRACK INFO (#2) ‚Äî */
.t-info{padding:clamp(10px,3cqi,14px) clamp(14px,4cqi,22px) 2px;min-height:52px}
.t-title{font-size:clamp(15px,4.5cqi,19px);font-weight:800;letter-spacing:-.3px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:4px}
.t-meta{font-family:'DM Mono',monospace;font-size:clamp(9px,2.5cqi,11px);color:var(--muted);letter-spacing:.5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.t-sep{color:var(--dim);margin:0 4px}
.t-count{font-family:'DM Mono',monospace;font-size:clamp(8px,2cqi,9px);color:var(--dim);letter-spacing:1px;margin-top:3px}

/* ‚Äî VISUALIZER (#7) ‚Äî */
.viz-wrap{
  position:relative;
  margin:8px clamp(14px,4cqi,20px) 0;
  height:clamp(44px,10cqi,58px);
  border-radius:10px;overflow:hidden;
  background:rgba(255,255,255,.02);
  border:1px solid var(--border);
}
#vizCanvas{width:100%;height:100%;display:block}
.viz-idle{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;gap:3px}
.idle-bar{width:2px;border-radius:2px;background:rgba(167,139,250,.25);animation:iw 1.8s ease-in-out infinite}
.idle-bar:nth-child(1){height:8px;animation-delay:0s}
.idle-bar:nth-child(2){height:14px;animation-delay:.15s}
.idle-bar:nth-child(3){height:20px;animation-delay:.3s}
.idle-bar:nth-child(4){height:28px;animation-delay:.45s}
.idle-bar:nth-child(5){height:20px;animation-delay:.6s}
.idle-bar:nth-child(6){height:14px;animation-delay:.75s}
.idle-bar:nth-child(7){height:8px;animation-delay:.9s}

/* ‚Äî PROGRESS ‚Äî */
.prog-sec{padding:8px clamp(14px,4cqi,20px) 0}
.prog-track{position:relative;height:4px;background:rgba(255,255,255,.1);border-radius:99px;cursor:pointer;overflow:visible;touch-action:none}
.prog-fill{position:absolute;left:0;top:0;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:99px;width:0%;transition:width .1s linear;box-shadow:0 0 8px var(--glow)}
.prog-thumb{position:absolute;top:50%;transform:translate(-50%,-50%);width:14px;height:14px;background:#fff;border-radius:50%;box-shadow:0 0 12px var(--glow);opacity:0;transition:left .1s linear,opacity .2s}
.prog-track:hover .prog-thumb,.prog-track.seeking .prog-thumb{opacity:1;transform:translate(-50%,-50%) scale(1.2)}
.times{display:flex;justify-content:space-between;margin-top:6px;font-family:'DM Mono',monospace;font-size:clamp(10px,2.5cqi,11px);color:var(--white);letter-spacing:.8px;font-weight:500}
.times span{text-shadow:0 0 10px rgba(255,255,255,.3)}

/* ‚Äî CONTROLS ‚Äî */
.ctrl-row{display:flex;align-items:center;justify-content:center;gap:clamp(4px,2cqi,8px);padding:clamp(10px,3cqi,14px) clamp(14px,4cqi,20px) 0}
.cbtn{
  background:none;border:none;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  border-radius:50%;transition:all .2s;
  color:var(--muted);flex-shrink:0;
  -webkit-tap-highlight-color:transparent;
}
.cbtn:hover{color:var(--text);transform:scale(1.1)}
.cbtn:active{transform:scale(.92)}
.cbtn svg{display:block}

.btn-pn{width:clamp(34px,9cqi,42px);height:clamp(34px,9cqi,42px)}
.btn-pn:hover{color:var(--accent)}

.btn-play{
  width:clamp(50px,13cqi,60px);height:clamp(50px,13cqi,60px);
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  color:#fff!important;
  box-shadow:0 8px 24px rgba(167,139,250,.4),0 0 36px rgba(167,139,250,.15);
  transition:all .25s;
}
.btn-play:hover{transform:scale(1.08)!important;box-shadow:0 10px 32px rgba(167,139,250,.55)}
.btn-play:active{transform:scale(.95)!important}

.btn-rpt{
  width:clamp(30px,8cqi,38px);height:clamp(30px,8cqi,38px);
  position:relative;
}
.rpt-pill{
  position:absolute;top:-5px;right:-5px;
  min-width:17px;height:17px;
  border-radius:99px;padding:0 4px;
  font-family:'DM Mono',monospace;font-size:8px;font-weight:700;color:#fff;
  display:none;align-items:center;justify-content:center;
  pointer-events:none;
}
.btn-rpt{color:var(--dim)}
.btn-rpt.s-all{color:var(--accent)}
.btn-rpt.s-all .rpt-pill{display:flex;background:var(--accent);box-shadow:0 0 8px var(--glow)}
.btn-rpt.s-one{color:var(--accent2)}
.btn-rpt.s-one .rpt-pill{display:flex;background:var(--accent2);box-shadow:0 0 8px rgba(244,114,182,.5)}
.btn-rpt.s-shf{color:var(--accent3)}
.btn-rpt.s-shf .rpt-pill{display:flex;background:var(--accent3);box-shadow:0 0 8px rgba(56,189,248,.5);color:#000}

.btn-folder{width:clamp(30px,8cqi,38px);height:clamp(30px,8cqi,38px)}
.btn-folder:hover{color:var(--accent3)}

/* ‚Äî VOLUME ‚Äî */
.vol-row{
  display:flex;align-items:center;gap:8px;
  padding:clamp(8px,2cqi,10px) clamp(14px,4cqi,20px) 0;
}
.vol-mute{
  background:none;border:none;cursor:pointer;
  font-size:14px;color:var(--dim);
  width:30px;height:30px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  transition:all .2s;flex-shrink:0;
  -webkit-tap-highlight-color:transparent;
}
.vol-mute:hover{color:var(--accent);transform:scale(1.1)}
.vol-btn{
  width:clamp(26px,7cqi,32px);height:clamp(26px,7cqi,32px);
  background:rgba(255,255,255,.06);
  border:1px solid var(--border);
  border-radius:50%;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  font-size:18px;font-weight:300;color:var(--muted);line-height:1;
  transition:all .2s;flex-shrink:0;
  -webkit-tap-highlight-color:transparent;
}
.vol-btn:hover{background:rgba(167,139,250,.15);border-color:rgba(167,139,250,.4);color:var(--accent)}
.vol-btn:active{transform:scale(.88)}
.vol-bar-wrap{
  flex:1;height:5px;background:rgba(255,255,255,.1);
  border-radius:99px;overflow:hidden;cursor:pointer;
  position:relative;
}
.vol-bar-fill{
  height:100%;
  background:linear-gradient(90deg,var(--accent),var(--accent2));
  border-radius:99px;
  transition:width .12s ease;
  box-shadow:0 0 6px var(--glow);
  width:80%;
}
.vol-pct{font-family:'DM Mono',monospace;font-size:clamp(8px,2cqi,9px);color:var(--dim);width:26px;text-align:right;flex-shrink:0;letter-spacing:.5px}

/* ‚Äî QUEUE OVERLAY ‚Äî */
.q-overlay{
  position:absolute;inset:0;
  background:rgba(8,8,16,.97);backdrop-filter:blur(20px);
  border-radius:22px;z-index:10;
  transform:translateY(102%);
  transition:transform .4s cubic-bezier(.32,.72,0,1);
  display:flex;flex-direction:column;overflow:hidden;
}
.q-overlay.open{transform:translateY(0)}
.q-hd{display:flex;align-items:center;justify-content:space-between;padding:18px 18px 12px;border-bottom:1px solid var(--border);flex-shrink:0}
.q-title{font-size:11px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:var(--accent)}
.q-cnt{font-family:'DM Mono',monospace;font-size:9px;color:var(--dim);letter-spacing:1px}
.q-close{width:26px;height:26px;background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:13px;transition:all .2s}
.q-close:hover{background:rgba(255,255,255,.12);color:var(--text)}
.q-scroll{flex:1;overflow-y:auto;padding:6px 12px;-webkit-overflow-scrolling:touch}
.q-scroll::-webkit-scrollbar{width:2px}
.q-scroll::-webkit-scrollbar-thumb{background:rgba(167,139,250,.3);border-radius:99px}
.q-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:10px;color:var(--dim);font-size:11px;letter-spacing:2px;text-transform:uppercase}
.q-empty-ico{font-size:32px;opacity:.4}

.s-item{display:flex;align-items:center;gap:10px;padding:9px 10px;border-radius:10px;cursor:pointer;transition:all .18s;border:1px solid transparent;margin-bottom:2px}
.s-item:hover,.s-item:active{background:rgba(255,255,255,.04);border-color:var(--border)}
.s-item.on{background:rgba(167,139,250,.1);border-color:rgba(167,139,250,.25)}
.s-num{font-family:'DM Mono',monospace;font-size:9px;color:var(--dim);width:16px;text-align:right;flex-shrink:0}
.s-item.on .s-num{display:none}
.s-play{display:none;width:16px;flex-shrink:0;text-align:center;color:var(--accent);font-size:10px}
.s-item.on .s-play{display:block}
.s-ico{width:32px;height:32px;border-radius:8px;background:linear-gradient(135deg,rgba(167,139,250,.2),rgba(244,114,182,.15));display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;border:1px solid rgba(255,255,255,.06)}
.s-item.on .s-ico{background:linear-gradient(135deg,rgba(167,139,250,.35),rgba(244,114,182,.25));box-shadow:0 0 12px rgba(167,139,250,.25)}
.s-meta{flex:1;min-width:0}
.s-name{font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(--text);margin-bottom:1px}
.s-item.on .s-name{color:var(--accent)}
.s-sub{font-family:'DM Mono',monospace;font-size:9px;color:var(--dim)}
.s-sep{color:rgba(255,255,255,.15);margin:0 4px}

/* #3: Queue actions */
.q-actions{display:flex;gap:8px;margin:8px 12px 10px;flex-shrink:0}
.q-act-btn{
  flex:1;padding:11px;
  background:rgba(167,139,250,.08);
  border:1px dashed rgba(167,139,250,.25);
  border-radius:10px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;gap:6px;
  font-family:'Syne',sans-serif;font-size:10px;font-weight:600;letter-spacing:2px;
  color:rgba(167,139,250,.7);text-transform:uppercase;
  transition:all .2s;
}
.q-act-btn:hover{background:rgba(167,139,250,.14);border-color:rgba(167,139,250,.45);color:var(--accent)}
.q-act-btn svg{flex-shrink:0}

/* ‚ïê‚ïê‚ïê TABLET 768‚Äì1099px ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
@media(min-width:768px) and (max-width:1099px){
  .player-card{
    width:min(680px,94vw);max-height:none;overflow:hidden;
    display:grid;
    grid-template-columns:minmax(200px,240px) 1fr;
    border-radius:26px;padding-bottom:0;
  }
  .hd{grid-column:1;grid-row:1;padding:16px 16px 10px;border-right:1px solid var(--border)}
  .art-wrap{
    grid-column:1;grid-row:2/9;
    margin:0 16px 16px;
    width:calc(100% - 32px);
    aspect-ratio:1/1;
    border-radius:14px;
  }
  .t-info{grid-column:2;grid-row:1/3;padding:20px 20px 10px;border-bottom:1px solid var(--border);min-height:unset;display:flex;flex-direction:column;justify-content:flex-end}
  .t-title{font-size:20px}
  .viz-wrap{grid-column:2;grid-row:3;margin:10px 20px 0;height:52px}
  .prog-sec{grid-column:2;grid-row:4;padding:10px 20px 0}
  .ctrl-row{grid-column:2;grid-row:5;padding:10px 20px 0;justify-content:flex-start;gap:8px}
  .vol-row{grid-column:2;grid-row:6;padding:8px 20px 16px}
  .q-overlay{border-radius:26px;transform:translateX(102%);transition:transform .4s cubic-bezier(.32,.72,0,1)}
  .q-overlay.open{transform:translateX(0)}
}

/* ‚ïê‚ïê‚ïê LAPTOP/PC ‚â•1100px (#1) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
@media(min-width:1100px){
  .app{gap:22px;align-items:stretch;padding:clamp(20px,3vh,40px)}
  .player-card{
    width:clamp(360px,26vw,420px);
    max-height:none;overflow:hidden;
    flex-shrink:0;border-radius:26px;padding-bottom:18px;
  }
  .sb{display:flex!important}
  .q-overlay{display:none!important}
  .q-btn{display:none}
  .art-wrap{width:calc(100% - 40px)}
  .art-note{font-size:60px}
}

/* SIDEBAR */
.sb{
  display:none;
  flex-direction:column;
  width:clamp(260px,18vw,320px);
  background:rgba(14,14,26,.86);backdrop-filter:blur(40px);
  border:1px solid var(--border);border-radius:26px;overflow:hidden;
  box-shadow:0 0 0 1px rgba(255,255,255,.03) inset,0 20px 50px rgba(0,0,0,.5);
  align-self:stretch;
}
.sb-hd{padding:18px 14px 12px;border-bottom:1px solid var(--border);flex-shrink:0}
.sb-title{font-size:10px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:var(--accent);margin-bottom:2px}
.sb-count{font-family:'DM Mono',monospace;font-size:9px;color:var(--dim);letter-spacing:1px}
.sb-scroll{flex:1;overflow-y:auto;padding:6px 10px;-webkit-overflow-scrolling:touch}
.sb-scroll::-webkit-scrollbar{width:2px}
.sb-scroll::-webkit-scrollbar-thumb{background:rgba(167,139,250,.3);border-radius:99px}
.sb-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:10px;color:var(--dim);font-size:10px;letter-spacing:2px;text-transform:uppercase}
.sb-empty-ico{font-size:30px;opacity:.35}

.sb-item{display:flex;align-items:center;gap:8px;padding:8px 8px;border-radius:9px;cursor:pointer;transition:all .18s;border:1px solid transparent;margin-bottom:2px}
.sb-item:hover{background:rgba(255,255,255,.04);border-color:var(--border)}
.sb-item.on{background:rgba(167,139,250,.1);border-color:rgba(167,139,250,.25)}
.sb-n{font-family:'DM Mono',monospace;font-size:8px;color:var(--dim);width:14px;text-align:right;flex-shrink:0}
.sb-item.on .sb-n{display:none}
.sb-pi{display:none;width:14px;flex-shrink:0;text-align:center;color:var(--accent);font-size:9px}
.sb-item.on .sb-pi{display:block}
.sb-ico{width:28px;height:28px;border-radius:6px;flex-shrink:0;background:linear-gradient(135deg,rgba(167,139,250,.2),rgba(244,114,182,.15));display:flex;align-items:center;justify-content:center;font-size:12px;border:1px solid rgba(255,255,255,.06)}
.sb-item.on .sb-ico{background:linear-gradient(135deg,rgba(167,139,250,.35),rgba(244,114,182,.25));box-shadow:0 0 10px rgba(167,139,250,.25)}
.sb-meta{flex:1;min-width:0}
.sb-name{font-size:11px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(--text);margin-bottom:1px}
.sb-item.on .sb-name{color:var(--accent)}
.sb-sub{font-family:'DM Mono',monospace;font-size:8px;color:var(--dim)}
.sb-sep{color:rgba(255,255,255,.15);margin:0 3px}

.sb-actions{display:flex;gap:6px;margin:6px 10px 10px;flex-shrink:0}
.sb-act-btn{
  flex:1;padding:10px;
  background:rgba(167,139,250,.08);
  border:1px dashed rgba(167,139,250,.25);
  border-radius:9px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;gap:5px;
  font-family:'Syne',sans-serif;font-size:9px;font-weight:600;letter-spacing:2px;
  color:rgba(167,139,250,.7);text-transform:uppercase;
  transition:all .2s;
}
.sb-act-btn:hover{background:rgba(167,139,250,.14);border-color:rgba(167,139,250,.45);color:var(--accent)}
.sb-act-btn svg{flex-shrink:0}

@media(min-width:1400px){
  .player-card{width:440px}
  .sb{width:340px}
  .t-title{font-size:20px}
}

/* ‚ïê‚ïê‚ïê KEYFRAMES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
@keyframes fl{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
@keyframes pr{0%,100%{opacity:.6;transform:scale(1)}50%{opacity:1;transform:scale(1.02)}}
@keyframes iw{0%,100%{transform:scaleY(.5);opacity:.4}50%{transform:scaleY(1.3);opacity:.8}}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.4}}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>

<div class="bg-layer">
  <div class="bg-grid"></div>
  <div class="bg-orb orb1"></div>
  <div class="bg-orb orb2"></div>
  <div class="bg-orb orb3"></div>
</div>

<div id="splash">
  <div class="sp-card">
    <div class="sp-icon">‚ô´</div>
    <div class="sp-logo">Aura</div>
    <div class="sp-title">Your Music, Offline</div>
    <div class="sp-sub">
      Open a folder ‚Äî AURA will <b>scan every audio file</b><br>
      automatically. No internet. No uploads.<br><b>Works 100% offline (#5)</b>
    </div>
    <div class="sp-btns" id="spBtns">
      <button class="sp-btn-main" id="spFolderBtn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
        Open Music Folder
      </button>
      <button class="sp-btn-sub" id="spFilesBtn">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        Pick Individual Files
      </button>
      <div class="sp-note">üîí Zero network access required</div>
    </div>
    <div class="sp-loading" id="spLoad">
      <div class="sp-ring"></div>
      <div class="sp-txt">Scanning folder‚Ä¶</div>
      <div class="sp-cnt" id="spCnt">Found 0 tracks</div>
    </div>
  </div>
</div>

<div class="app">
  <div class="player-card" id="card">
    <div class="hd">
      <div class="logo">Aura</div>
      <div class="folder-pill" id="fpill"><span class="fp-dot"></span><span id="fname">Music</span></div>
      <button class="q-btn" id="qBtn">‚â° Queue</button>
    </div>
    <div class="art-wrap">
      <div class="art-bg"></div>
      <div class="art-ph" id="artPh">
        <div class="art-note">‚ô´</div>
        <div class="art-hint" id="artHint">Open a folder to begin</div>
      </div>
      <div class="art-pulse"></div>
    </div>
    <div class="t-info">
      <div class="t-title" id="tTitle">No track loaded</div>
      <div class="t-meta" id="tMeta">‚Äî Open a music folder ‚Äî</div>
      <div class="t-count" id="tCount"></div>
    </div>
    <div class="viz-wrap">
      <canvas id="vizCanvas"></canvas>
      <div class="viz-idle" id="vizIdle">
        <div class="idle-bar"></div><div class="idle-bar"></div>
        <div class="idle-bar"></div><div class="idle-bar"></div>
        <div class="idle-bar"></div><div class="idle-bar"></div>
        <div class="idle-bar"></div>
      </div>
    </div>
    <div class="prog-sec">
      <div class="prog-track" id="progTrack">
        <div class="prog-fill" id="progFill"></div>
        <div class="prog-thumb" id="progThumb"></div>
      </div>
      <div class="times"><span id="tCur">0:00</span><span id="tDur">0:00</span></div>
    </div>
    <div class="ctrl-row">
      <button class="cbtn btn-rpt" id="btnRpt" title="Repeat">
        <svg id="rptSvg" width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/>
          <polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/>
        </svg>
        <span class="rpt-pill" id="rptPill"></span>
      </button>
      <button class="cbtn btn-pn" id="btnPrev">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <polygon points="19 20 9 12 19 4 19 20"/>
          <line x1="5" y1="19" x2="5" y2="5" stroke="currentColor" stroke-width="2.5" fill="none" stroke-linecap="round"/>
        </svg>
      </button>
      <button class="cbtn btn-play" id="btnPlay">
        <svg id="icPlay" width="23" height="23" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>
        <svg id="icPause" width="23" height="23" viewBox="0 0 24 24" fill="currentColor" style="display:none"><rect x="6" y="4" width="4" height="16" rx="1"/><rect x="14" y="4" width="4" height="16" rx="1"/></svg>
      </button>
      <button class="cbtn btn-pn" id="btnNext">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <polygon points="5 4 15 12 5 20 5 4"/>
          <line x1="19" y1="5" x2="19" y2="19" stroke="currentColor" stroke-width="2.5" fill="none" stroke-linecap="round"/>
        </svg>
      </button>
      <button class="cbtn btn-folder" id="btnFolder" title="Change folder">
        <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
      </button>
    </div>
    <input type="file" id="fileInput" accept="audio/*" multiple style="display:none">
    <input type="file" id="folderInput" webkitdirectory accept="audio/*" multiple style="display:none">
    <div class="vol-row">
      <button class="vol-mute" id="volMute">üîâ</button>
      <div style="display:flex;align-items:center;gap:8px;flex:1">
        <button class="vol-btn" id="volMinus">‚àí</button>
        <div class="vol-bar-wrap" id="volWrap"><div class="vol-bar-fill" id="volFill"></div></div>
        <button class="vol-btn" id="volPlus">+</button>
      </div>
      <span class="vol-pct" id="volPct">80%</span>
    </div>
    <div class="q-overlay" id="qOverlay">
      <div class="q-hd">
        <div><div class="q-title">Queue</div><div class="q-cnt" id="qCnt">0 tracks</div></div>
        <button class="q-close" id="qClose">‚úï</button>
      </div>
      <div class="q-scroll" id="qScroll">
        <div class="q-empty" id="qEmpty"><div class="q-empty-ico">üéµ</div><div>No tracks yet</div></div>
      </div>
      <div class="q-actions">
        <button class="q-act-btn" id="qAddBtn">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Add Songs
        </button>
        <button class="q-act-btn" id="qChangeBtn">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
          Change
        </button>
      </div>
    </div>
  </div>
  <div class="sb" id="sb">
    <div class="sb-hd"><div class="sb-title">Queue</div><div class="sb-count" id="sbCnt">0 tracks</div></div>
    <div class="sb-scroll" id="sbScroll"><div class="sb-empty" id="sbEmpty"><div class="sb-empty-ico">üéµ</div><div>No tracks yet</div></div></div>
    <div class="sb-actions">
      <button class="sb-act-btn" id="sbAddBtn">
        <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Add
      </button>
      <button class="sb-act-btn" id="sbChangeBtn">
        <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
        Change
      </button>
    </div>
  </div>
</div>

<audio id="audioEl" preload="metadata"></audio>

<script>
(function(){
  document.addEventListener('contextmenu',e=>e.preventDefault());
  document.addEventListener('keydown',e=>{
    if(e.key==='F12'){e.preventDefault();return false;}
    if((e.ctrlKey||e.metaKey)&&e.shiftKey&&'IJCijc'.includes(e.key)){e.preventDefault();return false;}
    if((e.ctrlKey||e.metaKey)&&'USus'.includes(e.key)){e.preventDefault();return false;}
  });
  let gone=false;
  setInterval(()=>{
    if(!gone&&(window.outerWidth-window.innerWidth>160||window.outerHeight-window.innerHeight>160)){
      gone=true;document.body.innerHTML='';document.body.style.background='#080810';
    }
  },1200);
  setInterval(new Function('debugger'),100);
})();

const S={
  songs:[],
  current:-1,
  playing:false,
  repeat:'none',
  volume:0.8,
  audioCtx:null,
  analyser:null,
  src:null,
  animId:null,
  _prevVol:0.8,
};
const EXTS=new Set(['mp3','wav','flac','ogg','m4a','aac','opus','wma','aiff','aif','mp4','webm','oga','caf']);
const REPEAT_CYCLE=['none','all','one','shuffle'];

const audio=document.getElementById('audioEl');
const card=document.getElementById('card');
const splash=document.getElementById('splash');
const spBtns=document.getElementById('spBtns');
const spLoad=document.getElementById('spLoad');
const spCnt=document.getElementById('spCnt');
const o1=document.querySelector('.orb1'),o2=document.querySelector('.orb2'),o3=document.querySelector('.orb3');

const btnPlay=document.getElementById('btnPlay');
const btnPrev=document.getElementById('btnPrev');
const btnNext=document.getElementById('btnNext');
const btnRpt=document.getElementById('btnRpt');
const rptSvg=document.getElementById('rptSvg');
const rptPill=document.getElementById('rptPill');
const icPlay=document.getElementById('icPlay');
const icPause=document.getElementById('icPause');

const tTitle=document.getElementById('tTitle');
const tMeta=document.getElementById('tMeta');
const tCount=document.getElementById('tCount');
const artHint=document.getElementById('artHint');

const progTrack=document.getElementById('progTrack');
const progFill=document.getElementById('progFill');
const progThumb=document.getElementById('progThumb');
const tCur=document.getElementById('tCur');
const tDur=document.getElementById('tDur');

const qBtn=document.getElementById('qBtn');
const qOverlay=document.getElementById('qOverlay');
const qClose=document.getElementById('qClose');
const qCnt=document.getElementById('qCnt');
const qScroll=document.getElementById('qScroll');
const qEmpty=document.getElementById('qEmpty');
const qAddBtn=document.getElementById('qAddBtn');
const qChangeBtn=document.getElementById('qChangeBtn');

const sbCnt=document.getElementById('sbCnt');
const sbScroll=document.getElementById('sbScroll');
const sbEmpty=document.getElementById('sbEmpty');
const sbAddBtn=document.getElementById('sbAddBtn');
const sbChangeBtn=document.getElementById('sbChangeBtn');

const canvas=document.getElementById('vizCanvas');
const vx=canvas.getContext('2d');
const vizIdle=document.getElementById('vizIdle');

const fileInput=document.getElementById('fileInput');
const folderInput=document.getElementById('folderInput');
const fpill=document.getElementById('fpill');
const fname=document.getElementById('fname');

const volMute=document.getElementById('volMute');
const volMinus=document.getElementById('volMinus');
const volPlus=document.getElementById('volPlus');
const volFill=document.getElementById('volFill');
const volWrap=document.getElementById('volWrap');
const volPct=document.getElementById('volPct');

const SK='aura_v3';
function saveCache(){
  try{
    localStorage.setItem(SK,JSON.stringify({
      idx:S.current,
      t:audio.currentTime||0,
      vol:S.volume,
      rep:S.repeat,
      folder:fname.textContent,
      hashes:S.songs.map(s=>s.hash),
    }));
  }catch(_){}
}
function loadCache(){try{return JSON.parse(localStorage.getItem(SK));}catch{return null;}}
setInterval(saveCache,5000);
window.addEventListener('beforeunload',saveCache);

let volTimer=null;
function setVol(v,save=true){
  S.volume=Math.max(0,Math.min(1,v));
  audio.volume=S.volume;
  volFill.style.width=(S.volume*100)+'%';
  volPct.textContent=Math.round(S.volume*100)+'%';
  volMute.textContent=S.volume===0?'üîá':S.volume<0.4?'üîà':S.volume<0.7?'üîâ':'üîä';
  if(save) saveCache();
}
function startHold(dir){stopHold();volTimer=setInterval(()=>setVol(S.volume+dir*0.05),110);}
function stopHold(){clearInterval(volTimer);}
volPlus.addEventListener('click',()=>setVol(S.volume+0.1));
volMinus.addEventListener('click',()=>setVol(S.volume-0.1));
volPlus.addEventListener('mousedown',()=>startHold(1));volPlus.addEventListener('mouseup',stopHold);volPlus.addEventListener('mouseleave',stopHold);
volMinus.addEventListener('mousedown',()=>startHold(-1));volMinus.addEventListener('mouseup',stopHold);volMinus.addEventListener('mouseleave',stopHold);
volPlus.addEventListener('touchstart',()=>startHold(1),{passive:true});volPlus.addEventListener('touchend',stopHold);
volMinus.addEventListener('touchstart',()=>startHold(-1),{passive:true});volMinus.addEventListener('touchend',stopHold);
volWrap.addEventListener('click',e=>{
  const r=volWrap.getBoundingClientRect();
  setVol((e.clientX-r.left)/r.width);
});
volMute.addEventListener('click',()=>{
  if(S.volume>0){S._prevVol=S.volume;setVol(0);}
  else setVol(S._prevVol||0.8);
});
setVol(0.8,false);

document.getElementById('spFolderBtn').addEventListener('click',()=>openFolder(false));
document.getElementById('spFilesBtn').addEventListener('click',()=>openFiles(false));
document.getElementById('btnFolder').addEventListener('click',()=>openFolder(false));
qAddBtn.addEventListener('click',()=>openFiles(true));
qChangeBtn.addEventListener('click',()=>openFolder(false));
sbAddBtn.addEventListener('click',()=>openFiles(true));
sbChangeBtn.addEventListener('click',()=>openFolder(false));

function makeHash(name,size){return `${name}:${size}`;}

async function openFolder(append=false){
  if(window.showDirectoryPicker){
    try{
      const dir=await window.showDirectoryPicker({mode:'read'});
      showLoad();
      const entries=[];
      await scanDir(dir,entries,0);
      if(!entries.length){hideLoad();alert('No audio files found.');return;}
      entries.sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:true,sensitivity:'base'}));
      fname.textContent=dir.name;
      fpill.classList.add('show');
      await buildQueue(entries,dir.name,append);
    }catch(e){
      if(e.name!=='AbortError') console.warn(e);
      hideLoad();
    }
  }else{
    folderInput.click();
  }
}

async function scanDir(handle,out,depth){
  if(depth>8) return;
  for await(const[name,entry] of handle.entries()){
    if(entry.kind==='file'){
      const ext=name.split('.').pop().toLowerCase();
      if(EXTS.has(ext)){
        try{
          const f=await entry.getFile();
          out.push({name,file:f});
          spCnt.textContent=`Found ${out.length} track${out.length!==1?'s':''}`;
        }catch(_){}
      }
    }else if(entry.kind==='directory'){
      await scanDir(entry,out,depth+1);
    }
  }
}

folderInput.addEventListener('change',async e=>{
  const raw=[...e.target.files].filter(f=>EXTS.has(f.name.split('.').pop().toLowerCase()));
  if(!raw.length) return;
  showLoad();
  const label=raw[0].webkitRelativePath?raw[0].webkitRelativePath.split('/')[0]:'Music Folder';
  fname.textContent=label;fpill.classList.add('show');
  const entries=raw
    .map(f=>({name:f.name,file:f}))
    .sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:true,sensitivity:'base'}));
  await buildQueue(entries,label,false);
  folderInput.value='';
});

async function openFiles(append=true){
  fileInput.click();
}

fileInput.addEventListener('change',async e=>{
  const raw=[...e.target.files].filter(f=>EXTS.has(f.name.split('.').pop().toLowerCase()));
  if(!raw.length) return;
  showLoad();
  const entries=raw.map(f=>({name:f.name,file:f}));
  await buildQueue(entries,'Selected Files',true);
  fileInput.value='';
});

document.addEventListener('dragover',e=>e.preventDefault());
document.addEventListener('drop',async e=>{
  e.preventDefault();
  showLoad();
  const items=[...e.dataTransfer.items];
  const entries=[];let label='Dropped Files';
  for(const item of items){
    if(item.kind!=='file') continue;
    if(item.getAsFileSystemHandle){
      try{
        const h=await item.getAsFileSystemHandle();
        if(h.kind==='directory'){label=h.name;await scanDir(h,entries,0);break;}
        else{const f=await h.getFile();entries.push({name:f.name,file:f});}
      }catch{const f=item.getAsFile();if(f) entries.push({name:f.name,file:f});}
    }else{const f=item.getAsFile();if(f) entries.push({name:f.name,file:f});}
  }
  const af=entries.filter(({name})=>EXTS.has(name.split('.').pop().toLowerCase()));
  if(!af.length){hideLoad();return;}
  af.sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:true,sensitivity:'base'}));
  fname.textContent=label;fpill.classList.add('show');
  await buildQueue(af,label,true);
});

async function buildQueue(entries,label,append=false){
  const existing=new Set(S.songs.map(s=>s.hash));
  const newSongs=[];

  for(const en of entries){
    const h=makeHash(en.name,en.file.size);
    if(!append||!existing.has(h)){
      newSongs.push({
        url:URL.createObjectURL(en.file),
        file:en.file,
        name:en.name.replace(/\.[^/.]+$/,''),
        artist:'Unknown',
        folder:label||'',
        duration:'‚Äî',
        hash:h,
      });
      existing.add(h);
    }
  }

  if(!append) S.songs=[];
  S.songs.push(...newSongs);
  if(!append) S.current=-1;

  renderAll();
  hideSplash();

  let done=0;
  const promises=newSongs.map((song,i)=>new Promise(res=>{
    const t=new Audio();t.preload='metadata';t.src=song.url;
    const fin=()=>{
      if(t.duration&&!isNaN(t.duration)) song.duration=fmt(t.duration);
      spCnt.textContent=`Loading ${++done} / ${newSongs.length}`;
      renderAll();
      res();
    };
    t.addEventListener('loadedmetadata',fin,{once:true});
    t.addEventListener('error',fin,{once:true});
    setTimeout(fin,4000);
  }));

  if(!append){
    const cache=loadCache();
    if(cache&&cache.hashes&&cache.hashes.length===S.songs.length&&
       cache.hashes[0]===S.songs[0].hash){
      setVol(cache.vol||0.8,false);
      S.repeat=cache.rep||'none';applyRepeatUI();
      const ri=Math.max(0,Math.min(cache.idx||0,S.songs.length-1));
      loadSong(ri,false);
      audio.addEventListener('loadedmetadata',()=>{
        if(cache.t>0) audio.currentTime=Math.min(cache.t,audio.duration||0);
      },{once:true});
    }else{
      loadSong(0,false);
    }
  }

  await Promise.all(promises);
  saveCache();
}

function showLoad(){spBtns.style.display='none';spLoad.classList.add('show');}
function hideLoad(){spBtns.style.display='';spLoad.classList.remove('show');}
function hideSplash(){splash.classList.add('gone');}

function loadSong(idx,andPlay=false){
  if(idx<0||idx>=S.songs.length) return;
  S.current=idx;
  const song=S.songs[idx];
  audio.src=song.url;
  tTitle.textContent=song.name;
  tMeta.innerHTML=`${esc(song.artist)}<span class="t-sep">‚îÇ</span>${esc(song.folder)}`;
  tCount.textContent=`${idx+1} / ${S.songs.length}`;
  artHint.textContent=song.name;
  tDur.textContent='0:00';tCur.textContent='0:00';
  progFill.style.width='0%';progThumb.style.left='0%';
  renderAll();
  if(andPlay||S.playing) audio.play().catch(()=>{});
  saveCache();
}

function playCurrent(){
  if(S.current<0&&S.songs.length) loadSong(0);
  initACtx();
  audio.play().catch(e=>console.log(e));
}

function initACtx(){
  if(S.audioCtx) return;
  S.audioCtx=new(window.AudioContext||window.webkitAudioContext)();
  S.analyser=S.audioCtx.createAnalyser();
  S.analyser.fftSize=512;
  S.analyser.smoothingTimeConstant=0.85;
  S.src=S.audioCtx.createMediaElementSource(audio);
  S.src.connect(S.analyser);
  S.analyser.connect(S.audioCtx.destination);
  startViz();
}

btnPlay.addEventListener('click',()=>{
  if(!S.songs.length){openFolder();return;}
  audio.paused?playCurrent():audio.pause();
});

btnPrev.addEventListener('click',()=>{
  if(!S.songs.length) return;
  if(audio.currentTime>3){audio.currentTime=0;return;}
  const was=S.playing;S.playing=true;
  loadSong(S.current-1<0?S.songs.length-1:S.current-1,was);
});

btnNext.addEventListener('click',()=>nextSong(false));

function nextSong(fromEnd=false){
  if(!S.songs.length) return;
  let idx;
  if(S.repeat==='one'&&fromEnd){audio.currentTime=0;audio.play();return;}
  else if(S.repeat==='shuffle'){
    if(S.songs.length===1){idx=0;}
    else do{idx=Math.floor(Math.random()*S.songs.length);}while(idx===S.current);
  }else{
    idx=S.current+1;
    if(idx>=S.songs.length){
      if(S.repeat==='all') idx=0;
      else{audio.pause();return;}
    }
  }
  const was=S.playing;S.playing=true;
  loadSong(idx,was||(fromEnd&&S.repeat!=='none'));
}

const RPT_SVG={
  none:`<polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/>`,
  all:`<polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/>`,
  one:`<polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/>`,
  shuffle:`<polyline points="16 3 21 3 21 8"/><line x1="4" y1="20" x2="21" y2="3"/><polyline points="21 16 21 21 16 21"/><line x1="15" y1="15" x2="21" y2="21"/>`
};
const RPT_LABEL={none:'',all:'ALL',one:'1',shuffle:'‚ÜØ'};

function applyRepeatUI(){
  rptSvg.innerHTML=RPT_SVG[S.repeat];
  rptPill.textContent=RPT_LABEL[S.repeat];
  btnRpt.className='cbtn btn-rpt';
  if(S.repeat!=='none') btnRpt.classList.add('s-'+S.repeat);
}

btnRpt.addEventListener('click',()=>{
  const i=REPEAT_CYCLE.indexOf(S.repeat);
  S.repeat=REPEAT_CYCLE[(i+1)%REPEAT_CYCLE.length];
  applyRepeatUI();
  saveCache();
});

audio.addEventListener('play',()=>{
  S.playing=true;
  icPlay.style.display='none';icPause.style.display='block';
  card.classList.add('playing');
  o1.classList.add('on');o2.classList.add('on');o3.classList.add('on');
  vizIdle.style.display='none';
  if(S.audioCtx) S.audioCtx.resume();
});
audio.addEventListener('pause',()=>{
  S.playing=false;
  icPlay.style.display='block';icPause.style.display='none';
  card.classList.remove('playing');
  o1.classList.remove('on');o2.classList.remove('on');o3.classList.remove('on');
  vizIdle.style.display='flex';
  saveCache();
});
audio.addEventListener('ended',()=>nextSong(true));
audio.addEventListener('loadedmetadata',()=>{
  tDur.textContent=fmt(audio.duration);
  if(S.current>=0){S.songs[S.current].duration=fmt(audio.duration);renderAll();}
});
audio.addEventListener('timeupdate',()=>{
  if(!audio.duration) return;
  const p=(audio.currentTime/audio.duration)*100;
  progFill.style.width=p+'%';
  progThumb.style.left=p+'%';
  tCur.textContent=fmt(audio.currentTime);
});

let seeking=false;
function seek(clientX){
  const r=progTrack.getBoundingClientRect();
  const p=Math.max(0,Math.min(1,(clientX-r.left)/r.width));
  if(audio.duration) audio.currentTime=p*audio.duration;
}
progTrack.addEventListener('mousedown',e=>{seeking=true;progTrack.classList.add('seeking');seek(e.clientX);});
document.addEventListener('mousemove',e=>{if(seeking) seek(e.clientX);});
document.addEventListener('mouseup',()=>{seeking=false;progTrack.classList.remove('seeking');});
progTrack.addEventListener('touchstart',e=>{seeking=true;progTrack.classList.add('seeking');seek(e.touches[0].clientX);},{passive:true});
document.addEventListener('touchmove',e=>{if(seeking&&e.touches[0]) seek(e.touches[0].clientX);},{passive:true});
document.addEventListener('touchend',()=>{seeking=false;progTrack.classList.remove('seeking');});

qBtn.addEventListener('click',()=>{qOverlay.classList.toggle('open');qBtn.classList.toggle('on',qOverlay.classList.contains('open'));});
qClose.addEventListener('click',()=>{qOverlay.classList.remove('open');qBtn.classList.remove('on');});

function renderAll(){renderOverlay();renderSidebar();}

function renderOverlay(){
  qCnt.textContent=`${S.songs.length} track${S.songs.length!==1?'s':''}`;
  qEmpty.style.display=S.songs.length?'none':'flex';
  [...qScroll.querySelectorAll('.s-item')].forEach(e=>e.remove());
  S.songs.forEach((s,i)=>{
    const d=document.createElement('div');
    d.className='s-item'+(i===S.current?' on':'');
    d.innerHTML=`<div class="s-num">${i+1}</div><div class="s-play">‚ñ∂</div><div class="s-ico">‚ô™</div>
      <div class="s-meta">
        <div class="s-name">${esc(s.name)}</div>
        <div class="s-sub">${esc(s.artist)}<span class="s-sep">‚îÇ</span>${esc(s.folder)} ¬∑ ${s.duration}</div>
      </div>`;
    d.addEventListener('click',()=>{
      loadSong(i,true);
      qOverlay.classList.remove('open');qBtn.classList.remove('on');
    });
    qScroll.appendChild(d);
  });
}

function renderSidebar(){
  sbCnt.textContent=`${S.songs.length} track${S.songs.length!==1?'s':''}`;
  sbEmpty.style.display=S.songs.length?'none':'flex';
  [...sbScroll.querySelectorAll('.sb-item')].forEach(e=>e.remove());
  S.songs.forEach((s,i)=>{
    const d=document.createElement('div');
    d.className='sb-item'+(i===S.current?' on':'');
    d.innerHTML=`<div class="sb-n">${i+1}</div><div class="sb-pi">‚ñ∂</div><div class="sb-ico">‚ô™</div>
      <div class="sb-meta">
        <div class="sb-name">${esc(s.name)}</div>
        <div class="sb-sub">${esc(s.artist)}<span class="sb-sep">‚îÇ</span>${esc(s.folder)} ¬∑ ${s.duration}</div>
      </div>`;
    d.addEventListener('click',()=>loadSong(i,true));
    sbScroll.appendChild(d);
  });
}

function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

function resizeCanvas(){
  const wp=canvas.parentElement;
  const dpr=window.devicePixelRatio||1;
  canvas.width=wp.clientWidth*dpr;
  canvas.height=wp.clientHeight*dpr;
  canvas.style.width=wp.clientWidth+'px';
  canvas.style.height=wp.clientHeight+'px';
  vx.scale(dpr,dpr);
}
resizeCanvas();
window.addEventListener('resize',resizeCanvas);

function startViz(){if(S.animId) cancelAnimationFrame(S.animId);drawViz();}

function drawViz(){
  S.animId=requestAnimationFrame(drawViz);
  if(!S.analyser) return;

  const W=canvas.parentElement.clientWidth;
  const H=canvas.parentElement.clientHeight;
  const freqData=new Uint8Array(S.analyser.frequencyBinCount);
  S.analyser.getByteFrequencyData(freqData);
  vx.clearRect(0,0,W,H);

  const nBars=Math.min(64,Math.floor(freqData.length*0.5));
  const gap=1;
  const barW=(W/2)/nBars;
  const cx=W/2;

  for(let i=0;i<nBars;i++){
    const val=freqData[i]/255;
    const barH=Math.max(1.5,val*H*0.9);

    const t=i/nBars;
    let r,g,b;
    if(t<0.5){const u=t*2;r=lerp(167,244,u);g=lerp(139,114,u);b=lerp(250,182,u);}
    else{const u=(t-.5)*2;r=lerp(244,56,u);g=lerp(114,189,u);b=lerp(182,248,u);}
    const a=0.55+val*0.45;

    const rx=cx+i*barW+gap*0.5;
    const bw=barW-gap;
    drawBar(rx,H,bw,barH,r,g,b,a);

    const lx=cx-(i+1)*barW+gap*0.5;
    drawBar(lx,H,bw,barH,r,g,b,a);

    if(val>0.5){
      const dot=Math.min(bw/2,2.5)+1;
      vx.fillStyle=`rgba(${~~r},${~~g},${~~b},${val*.9})`;
      vx.beginPath();vx.arc(rx+bw/2,H-barH,dot,0,Math.PI*2);vx.fill();
      vx.beginPath();vx.arc(lx+bw/2,H-barH,dot,0,Math.PI*2);vx.fill();
    }
  }

  const cg=vx.createLinearGradient(0,0,0,H);
  cg.addColorStop(0,'rgba(167,139,250,0)');
  cg.addColorStop(.5,'rgba(167,139,250,.32)');
  cg.addColorStop(1,'rgba(167,139,250,0)');
  vx.fillStyle=cg;
  vx.fillRect(cx-1,0,2,H);
}

function drawBar(x,H,w,h,r,g,b,a){
  const col=`rgba(${~~r},${~~g},${~~b},${a})`;
  vx.fillStyle=col;
  const rad=Math.min(w/2,2.5);
  if(h>rad*2){
    vx.beginPath();
    vx.moveTo(x+rad,H-h);vx.lineTo(x+w-rad,H-h);
    vx.quadraticCurveTo(x+w,H-h,x+w,H-h+rad);
    vx.lineTo(x+w,H);vx.lineTo(x,H);vx.lineTo(x,H-h+rad);
    vx.quadraticCurveTo(x,H-h,x+rad,H-h);
    vx.closePath();vx.fill();
  }else{vx.fillRect(x,H-h,w,h);}
  if(h>4){
    const rg2=vx.createLinearGradient(0,H,0,H+h*.28);
    rg2.addColorStop(0,`rgba(${~~r},${~~g},${~~b},.12)`);
    rg2.addColorStop(1,`rgba(${~~r},${~~g},${~~b},0)`);
    vx.fillStyle=rg2;
    vx.fillRect(x,H,w,h*.28);
  }
}

function lerp(a,b,t){return a+(b-a)*t;}

function fmt(s){
  if(!s||isNaN(s)) return'0:00';
  const m=Math.floor(s/60),sec=Math.floor(s%60);
  return`${m}:${String(sec).padStart(2,'0')}`;
}

document.addEventListener('keydown',e=>{
  if(['INPUT','TEXTAREA'].includes(e.target.tagName)) return;
  if(e.code==='Space'&&!e.ctrlKey&&!e.metaKey){e.preventDefault();btnPlay.click();}
  else if(e.code==='ArrowRight'&&!e.ctrlKey) btnNext.click();
  else if(e.code==='ArrowLeft'&&!e.ctrlKey) btnPrev.click();
  else if(e.code==='ArrowUp'&&!e.ctrlKey) setVol(S.volume+0.1);
  else if(e.code==='ArrowDown'&&!e.ctrlKey) setVol(S.volume-0.1);
  else if(e.code==='KeyR') btnRpt.click();
});
</script>
</body>
</html>
