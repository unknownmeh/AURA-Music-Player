<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#080810">
<title>AURA â€” Music Player</title>
<!-- Google Fonts: loads when online, system fonts kick in offline automatically -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
/* â”€â”€â”€ RESET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

/* â”€â”€â”€ DESIGN TOKENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root{
  --bg:#080810;
  --surface:rgba(12,12,24,0.94);
  --card:#14142a;
  --border:rgba(255,255,255,0.07);
  --A:#a78bfa;   /* violet */
  --A2:#f472b6;  /* pink   */
  --A3:#38bdf8;  /* cyan   */
  --glow:rgba(167,139,250,0.35);
  --tx:#f1f0ff;
  --mu:rgba(241,240,255,0.45);
  --di:rgba(241,240,255,0.22);
  /* Offline-safe font: Syne when online, good system-ui when offline */
  --ff:'Syne','Inter','Segoe UI',system-ui,-apple-system,sans-serif;
  --ffm:'DM Mono','Fira Mono','Consolas',monospace;
}

html,body{
  width:100%;height:100%;
  background:var(--bg);color:var(--tx);
  font-family:var(--ff);
  overflow:hidden;
  -webkit-user-select:none;user-select:none;
  -webkit-tap-highlight-color:transparent;
  touch-action:manipulation;
  overscroll-behavior:none;
}

/* â”€â”€â”€ BACKGROUND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.bg{position:fixed;inset:0;pointer-events:none;z-index:0;overflow:hidden}
.orb{position:absolute;border-radius:50%;filter:blur(90px);opacity:0;transition:opacity 1.8s ease}
.o1{width:600px;height:600px;background:radial-gradient(circle,rgba(167,139,250,.2),transparent 70%);top:-200px;left:-150px}
.o2{width:500px;height:500px;background:radial-gradient(circle,rgba(244,114,182,.16),transparent 70%);bottom:-150px;right:-100px}
.o3{width:380px;height:380px;background:radial-gradient(circle,rgba(56,189,248,.13),transparent 70%);top:40%;left:50%;transform:translate(-50%,-50%)}
.orb.on{opacity:1}
.grid{position:absolute;inset:0;
  background-image:linear-gradient(rgba(255,255,255,.015)1px,transparent 1px),
                   linear-gradient(90deg,rgba(255,255,255,.015)1px,transparent 1px);
  background-size:52px 52px}

/* â”€â”€â”€ SPLASH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#splash{
  position:fixed;inset:0;z-index:200;
  display:flex;align-items:center;justify-content:center;
  background:var(--bg);
  transition:opacity .55s,visibility .55s;
  padding:max(16px,env(safe-area-inset-top)) 20px max(16px,env(safe-area-inset-bottom));
}
#splash.gone{opacity:0;visibility:hidden;pointer-events:none}

.sp-card{
  width:min(420px,100%);
  background:rgba(12,12,24,.97);
  backdrop-filter:blur(40px);
  border:1px solid rgba(167,139,250,.2);
  border-radius:clamp(20px,3vw,28px);
  padding:clamp(22px,4vw,40px) clamp(18px,4vw,36px);
  text-align:center;
  box-shadow:0 0 0 1px rgba(255,255,255,.04) inset,0 32px 80px rgba(0,0,0,.7),0 0 60px rgba(167,139,250,.08);
  display:flex;flex-direction:column;align-items:center;
}
.sp-ico{font-size:clamp(42px,8vw,60px);line-height:1;margin-bottom:12px;
  filter:drop-shadow(0 0 20px rgba(167,139,250,.7));animation:fl 4s ease-in-out infinite}
.sp-logo{font-size:10px;font-weight:700;letter-spacing:5px;color:var(--A);text-transform:uppercase;margin-bottom:10px}
.sp-h{font-size:clamp(19px,4vw,25px);font-weight:800;letter-spacing:-.5px;margin-bottom:8px}
.sp-p{font-family:var(--ffm);font-size:clamp(10px,2vw,12px);color:var(--mu);line-height:1.8;margin-bottom:22px}
.sp-p em{color:var(--A);font-style:normal}
.sp-btns{width:100%}
.sp-main{
  width:100%;padding:clamp(12px,2.5vw,15px) 20px;
  background:linear-gradient(135deg,var(--A),var(--A2));border:none;border-radius:12px;
  font-family:var(--ff);font-size:clamp(11px,2.5vw,13px);font-weight:700;letter-spacing:1.5px;
  color:#fff;text-transform:uppercase;cursor:pointer;
  box-shadow:0 8px 28px rgba(167,139,250,.38);
  transition:all .22s;display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:9px;
}
.sp-main:hover{transform:translateY(-2px);box-shadow:0 12px 36px rgba(167,139,250,.52)}
.sp-main:active{transform:scale(.97)}
.sp-sub{
  width:100%;padding:clamp(10px,2vw,12px) 20px;
  background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:10px;
  font-family:var(--ff);font-size:clamp(10px,2vw,11px);font-weight:600;letter-spacing:1.5px;
  color:var(--mu);text-transform:uppercase;cursor:pointer;
  transition:all .2s;display:flex;align-items:center;justify-content:center;gap:7px;margin-bottom:13px;
}
.sp-sub:hover{background:rgba(167,139,250,.1);border-color:rgba(167,139,250,.3);color:var(--A)}
.sp-note{font-family:var(--ffm);font-size:10px;color:var(--di)}
.sp-ld{display:none;flex-direction:column;align-items:center;gap:11px;width:100%}
.sp-ld.on{display:flex}
.sp-ring{width:40px;height:40px;border:3px solid rgba(167,139,250,.18);border-top-color:var(--A);border-radius:50%;animation:spin .8s linear infinite}
.sp-ltxt{font-family:var(--ffm);font-size:11px;color:var(--mu);letter-spacing:1px}
.sp-cnt{font-size:11px;color:var(--A);font-family:var(--ffm)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LAYOUT â€” auto-scales to ANY window
   Uses svh/svw + vmin so nothing clips
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.app{
  position:relative;z-index:1;
  width:100svw;height:100svh;
  display:flex;align-items:center;justify-content:center;
}

/* PLAYER CARD â€” mobile-first, fits every screen */
.pc{
  position:relative;
  /* width = 92% of the shorter viewport dimension, never above 390px */
  width:min(390px,92vmin,calc(100vw - 16px));
  max-height:calc(100svh - 16px);
  overflow-y:auto;overflow-x:hidden;scrollbar-width:none;
  background:var(--surface);backdrop-filter:blur(40px);
  border:1px solid var(--border);
  border-radius:clamp(16px,2.5vmin,24px);
  box-shadow:0 0 0 1px rgba(255,255,255,.04) inset,
             0 24px 60px rgba(0,0,0,.6),
             0 0 50px rgba(167,139,250,.04);
  transition:box-shadow .6s;
  padding-bottom:max(16px,env(safe-area-inset-bottom,0px));
}
.pc::-webkit-scrollbar{display:none}
.pc.playing{box-shadow:0 0 0 1px rgba(255,255,255,.05) inset,
  0 24px 60px rgba(0,0,0,.7),0 0 65px rgba(167,139,250,.13)}

/* HEADER */
.hd{display:flex;align-items:center;justify-content:space-between;
  padding:clamp(11px,2.5vmin,18px) clamp(14px,3.5vmin,22px) 10px;gap:8px}
.logo{font-size:10px;font-weight:700;letter-spacing:4px;color:var(--A);text-transform:uppercase;opacity:.9;flex-shrink:0}
.fp{display:none;align-items:center;gap:5px;
  background:rgba(56,189,248,.1);border:1px solid rgba(56,189,248,.26);
  border-radius:20px;padding:3px 9px;
  font-family:var(--ffm);font-size:8px;letter-spacing:1px;color:var(--A3);
  max-width:min(110px,22vw);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.fp.on{display:flex}
.fp-dot{width:5px;height:5px;border-radius:50%;background:var(--A3);flex-shrink:0;animation:blink 2s ease-in-out infinite}
.qbtn{
  display:flex;align-items:center;gap:5px;
  background:rgba(255,255,255,.05);border:1px solid var(--border);
  border-radius:20px;padding:5px 11px;cursor:pointer;
  font-family:var(--ff);font-size:10px;font-weight:600;letter-spacing:1.5px;
  color:var(--mu);text-transform:uppercase;transition:all .22s;flex-shrink:0;
}
.qbtn:hover,.qbtn.on{background:rgba(167,139,250,.14);border-color:rgba(167,139,250,.38);color:var(--A)}

/* ARTWORK */
.art{
  position:relative;
  margin:0 clamp(14px,3.5vmin,20px) 4px;
  width:calc(100% - clamp(28px,7vmin,40px));
  aspect-ratio:1;
  border-radius:14px;overflow:hidden;
  background:var(--card);
  box-shadow:0 12px 40px rgba(0,0,0,.5);flex-shrink:0;
}
.art::after{content:'';position:absolute;inset:0;border-radius:14px;border:1px solid rgba(255,255,255,.08);pointer-events:none}
.art-bg{position:absolute;inset:0;background:linear-gradient(135deg,#1a1a3e,#0d0d22 50%,#1a0d2e)}
.art-ph{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px}
.art-ico{font-size:clamp(34px,7vmin,52px);line-height:1;filter:drop-shadow(0 0 18px rgba(167,139,250,.6));animation:fl 4s ease-in-out infinite}
.art-hint{font-size:clamp(8px,1.8vmin,10px);letter-spacing:2px;font-weight:600;color:var(--di);text-transform:uppercase;text-align:center;padding:0 12px}
.art-pulse{position:absolute;inset:0;border-radius:14px;
  background:radial-gradient(circle at 50%,rgba(167,139,250,.08),transparent 70%);
  opacity:0;transition:opacity .6s}
.pc.playing .art-pulse{opacity:1;animation:pulse 2s ease-in-out infinite}

/* TRACK INFO â€” name on top, "artist | folder" below */
.ti{padding:clamp(9px,2vmin,13px) clamp(14px,3.5vmin,22px) 2px}
.ti-name{
  font-size:clamp(14px,3.2vmin,19px);font-weight:800;letter-spacing:-.3px;
  color:var(--tx);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:4px}
.ti-sub{
  display:flex;align-items:center;gap:5px;
  font-family:var(--ffm);font-size:clamp(9px,1.9vmin,11px);color:var(--mu);
  white-space:nowrap;overflow:hidden;
}
.ti-artist{overflow:hidden;text-overflow:ellipsis;flex-shrink:1;min-width:0}
.ti-sep{color:var(--di);flex-shrink:0;opacity:.8;display:none}
.ti-folder{color:var(--A3);opacity:.8;flex-shrink:0;overflow:hidden;text-overflow:ellipsis;max-width:35%}
.ti-count{font-family:var(--ffm);font-size:9px;color:var(--di);letter-spacing:1px;margin-top:3px}

/* VISUALIZER â€” smooth mirrored bars from centre */
.viz{
  position:relative;
  margin:8px clamp(14px,3.5vmin,20px) 0;
  height:clamp(42px,7vmin,58px);
  border-radius:10px;overflow:hidden;
  background:rgba(255,255,255,.02);border:1px solid var(--border);
}
#vc{width:100%;height:100%;display:block}
.viz-idle{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;gap:3px}
.ib{width:2px;border-radius:2px;background:rgba(167,139,250,.22);animation:iw 1.8s ease-in-out infinite}
.ib:nth-child(1){height:7px;animation-delay:0s}
.ib:nth-child(2){height:12px;animation-delay:.15s}
.ib:nth-child(3){height:18px;animation-delay:.3s}
.ib:nth-child(4){height:26px;animation-delay:.45s}
.ib:nth-child(5){height:18px;animation-delay:.6s}
.ib:nth-child(6){height:12px;animation-delay:.75s}
.ib:nth-child(7){height:7px;animation-delay:.9s}

/* PROGRESS */
.prg{padding:8px clamp(14px,3.5vmin,20px) 0}
.pt{position:relative;height:4px;background:rgba(255,255,255,.1);border-radius:99px;cursor:pointer;touch-action:none}
.pf{position:absolute;left:0;top:0;height:100%;
  background:linear-gradient(90deg,var(--A),var(--A2));
  border-radius:99px;width:0%;transition:width .1s linear;box-shadow:0 0 7px var(--glow)}
.pt-th{position:absolute;top:50%;transform:translate(-50%,-50%);
  width:13px;height:13px;background:#fff;border-radius:50%;
  box-shadow:0 0 10px var(--glow);opacity:0;transition:left .1s linear,opacity .18s}
.pt:hover .pt-th,.pt.drag .pt-th{opacity:1;transform:translate(-50%,-50%) scale(1.2)}
.times{display:flex;justify-content:space-between;margin-top:5px;
  font-family:var(--ffm);font-size:clamp(10px,2vmin,11px);
  color:#fff;letter-spacing:.8px;font-weight:500}
.times span{text-shadow:0 0 10px rgba(255,255,255,.28)}

/* CONTROLS */
.ctrl{display:flex;align-items:center;justify-content:center;
  gap:clamp(3px,1.5vmin,8px);
  padding:clamp(9px,2vmin,13px) clamp(14px,3.5vmin,20px) 0}
.cb{background:none;border:none;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  border-radius:50%;transition:all .18s;color:var(--mu);flex-shrink:0;
  -webkit-tap-highlight-color:transparent}
.cb:hover{color:var(--tx);transform:scale(1.1)}
.cb:active{transform:scale(.9)}
.cb svg{display:block;pointer-events:none}
.btn-pn{width:clamp(32px,7vmin,42px);height:clamp(32px,7vmin,42px)}
.btn-pn:hover{color:var(--A)}
.btn-play{
  width:clamp(48px,10vmin,60px);height:clamp(48px,10vmin,60px);
  background:linear-gradient(135deg,var(--A),var(--A2));
  color:#fff!important;
  box-shadow:0 8px 24px rgba(167,139,250,.38),0 0 32px rgba(167,139,250,.12);
}
.btn-play:hover{transform:scale(1.08)!important;box-shadow:0 10px 30px rgba(167,139,250,.52)}
.btn-play:active{transform:scale(.94)!important}

/* REPEAT â€” 4 crisp visual states */
.btn-rpt{width:clamp(28px,6vmin,36px);height:clamp(28px,6vmin,36px);position:relative;color:var(--di)}
.rpt-badge{
  position:absolute;top:-5px;right:-5px;
  min-width:16px;height:16px;border-radius:99px;padding:0 3px;
  font-family:var(--ffm);font-size:7px;font-weight:700;color:#fff;
  display:none;align-items:center;justify-content:center;pointer-events:none;
}
.btn-rpt.s-all{color:var(--A)} .btn-rpt.s-all .rpt-badge{display:flex;background:var(--A);box-shadow:0 0 7px var(--glow)}
.btn-rpt.s-one{color:var(--A2)} .btn-rpt.s-one .rpt-badge{display:flex;background:var(--A2);box-shadow:0 0 7px rgba(244,114,182,.45)}
.btn-rpt.s-shf{color:var(--A3)} .btn-rpt.s-shf .rpt-badge{display:flex;background:var(--A3);box-shadow:0 0 7px rgba(56,189,248,.45);color:#000}
.btn-fld{width:clamp(28px,6vmin,36px);height:clamp(28px,6vmin,36px)}
.btn-fld:hover{color:var(--A3)}

/* VOLUME â€” analogue +/- */
.vol{display:flex;align-items:center;gap:8px;
  padding:clamp(7px,1.8vmin,10px) clamp(14px,3.5vmin,20px) 0}
.vol-mute{background:none;border:none;cursor:pointer;font-size:14px;color:var(--di);
  width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;
  transition:all .18s;flex-shrink:0}
.vol-mute:hover{color:var(--A);transform:scale(1.1)}
.vbtn{
  width:clamp(24px,5vmin,30px);height:clamp(24px,5vmin,30px);
  background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:50%;
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  font-size:17px;font-weight:300;color:var(--mu);line-height:1;
  transition:all .18s;flex-shrink:0;-webkit-tap-highlight-color:transparent}
.vbtn:hover{background:rgba(167,139,250,.14);border-color:rgba(167,139,250,.38);color:var(--A)}
.vbtn:active{transform:scale(.88)}
.vbar{flex:1;height:5px;background:rgba(255,255,255,.1);border-radius:99px;overflow:hidden;cursor:pointer}
.vfill{height:100%;background:linear-gradient(90deg,var(--A),var(--A2));
  border-radius:99px;transition:width .12s;box-shadow:0 0 5px var(--glow);width:80%}
.vpct{font-family:var(--ffm);font-size:9px;color:var(--di);width:25px;text-align:right;flex-shrink:0;letter-spacing:.5px}

/* â”€â”€ QUEUE OVERLAY (mobile/tablet) â”€â”€â”€â”€â”€ */
.qov{
  position:absolute;inset:0;
  background:rgba(6,6,16,.97);backdrop-filter:blur(22px);
  border-radius:inherit;z-index:10;
  transform:translateY(105%);
  transition:transform .4s cubic-bezier(.32,.72,0,1);
  display:flex;flex-direction:column;overflow:hidden;
}
.qov.open{transform:translateY(0)}
.qov-hd{display:flex;align-items:center;justify-content:space-between;
  padding:16px 16px 11px;border-bottom:1px solid var(--border);flex-shrink:0}
.qov-title{font-size:10px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:var(--A)}
.qov-cnt{font-family:var(--ffm);font-size:9px;color:var(--di);letter-spacing:1px}
.qov-x{width:25px;height:25px;background:rgba(255,255,255,.06);border:1px solid var(--border);
  border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;
  color:var(--mu);font-size:13px;transition:all .18s}
.qov-x:hover{background:rgba(255,255,255,.12);color:var(--tx)}
.qsc{flex:1;overflow-y:auto;padding:5px 11px;-webkit-overflow-scrolling:touch}
.qsc::-webkit-scrollbar{width:2px}
.qsc::-webkit-scrollbar-thumb{background:rgba(167,139,250,.28);border-radius:99px}
.qempty{display:flex;flex-direction:column;align-items:center;justify-content:center;
  height:100%;gap:9px;color:var(--di);font-size:10px;letter-spacing:2px;text-transform:uppercase}
.qempty-ico{font-size:30px;opacity:.4}

/* Song row â€” used in both overlay and sidebar */
.row{display:flex;align-items:center;gap:9px;padding:8px 9px;border-radius:10px;
  cursor:pointer;transition:all .16s;border:1px solid transparent;margin-bottom:2px}
.row:hover,.row:active{background:rgba(255,255,255,.04);border-color:var(--border)}
.row.on{background:rgba(167,139,250,.09);border-color:rgba(167,139,250,.24)}
.row-n{font-family:var(--ffm);font-size:8px;color:var(--di);width:15px;text-align:right;flex-shrink:0}
.row.on .row-n{display:none}
.row-pl{display:none;width:15px;flex-shrink:0;text-align:center;color:var(--A);font-size:9px}
.row.on .row-pl{display:block}
.row-ico{width:30px;height:30px;border-radius:7px;flex-shrink:0;
  background:linear-gradient(135deg,rgba(167,139,250,.18),rgba(244,114,182,.12));
  display:flex;align-items:center;justify-content:center;font-size:13px;
  border:1px solid rgba(255,255,255,.06)}
.row.on .row-ico{background:linear-gradient(135deg,rgba(167,139,250,.3),rgba(244,114,182,.22));
  box-shadow:0 0 10px rgba(167,139,250,.22)}
.row-meta{flex:1;min-width:0}
.row-name{font-size:11px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  color:var(--tx);margin-bottom:1px}
.row.on .row-name{color:var(--A)}
.row-info{font-family:var(--ffm);font-size:8px;color:var(--di)}

/* Queue footer â€” two buttons side by side */
.qfooter{display:flex;gap:7px;margin:7px 11px 9px;flex-shrink:0}
.qfoot-btn{
  flex:1;padding:10px 6px;
  border-radius:9px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;gap:5px;
  font-family:var(--ff);font-size:9px;font-weight:600;letter-spacing:1.5px;
  text-transform:uppercase;transition:all .18s;border:1px dashed;
}
.qfoot-btn.add{
  background:rgba(167,139,250,.07);border-color:rgba(167,139,250,.24);color:rgba(167,139,250,.75)}
.qfoot-btn.add:hover{background:rgba(167,139,250,.14);border-color:rgba(167,139,250,.45);color:var(--A)}
.qfoot-btn.fld{
  background:rgba(56,189,248,.06);border-color:rgba(56,189,248,.22);color:rgba(56,189,248,.7)}
.qfoot-btn.fld:hover{background:rgba(56,189,248,.13);border-color:rgba(56,189,248,.44);color:var(--A3)}

/* â”€â”€ TABLET 768â€“1099px â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media(min-width:768px) and (max-width:1099px){
  .pc{
    width:min(680px,94vw);max-height:none;overflow:hidden;
    display:grid;grid-template-columns:minmax(190px,230px) 1fr;
    border-radius:24px;padding-bottom:0;
  }
  .hd{grid-column:1;grid-row:1;padding:15px 15px 9px;border-right:1px solid var(--border)}
  .art{grid-column:1;grid-row:2/9;margin:0 15px 15px;width:calc(100% - 30px);aspect-ratio:1;border-radius:12px}
  .ti{grid-column:2;grid-row:1/3;padding:18px 18px 9px;border-bottom:1px solid var(--border);
    display:flex;flex-direction:column;justify-content:flex-end}
  .ti-name{font-size:clamp(16px,2.5vw,20px)}
  .viz{grid-column:2;grid-row:3;margin:10px 18px 0;height:50px}
  .prg{grid-column:2;grid-row:4;padding:9px 18px 0}
  .ctrl{grid-column:2;grid-row:5;padding:9px 18px 0;justify-content:flex-start;gap:8px}
  .vol{grid-column:2;grid-row:6;padding:7px 18px 15px}
  .qov{border-radius:24px;transform:translateX(105%)}
  .qov.open{transform:translateX(0)}
}

/* â”€â”€ LAPTOP/PC â‰¥1100px â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media(min-width:1100px){
  .app{
    gap:clamp(14px,1.8vw,26px);
    align-items:stretch;
    padding:clamp(14px,2vh,36px);
  }
  .pc{
    /* Auto-sizes: 30% of viewport width, clipped to reasonable range */
    width:clamp(300px,30vw,440px);
    max-height:calc(100svh - clamp(28px,4vh,72px));
    overflow:hidden;flex-shrink:0;
    border-radius:clamp(16px,2vmin,26px);
    padding-bottom:clamp(12px,2vh,20px);
  }
  .sb{display:flex!important}
  .qov{display:none!important}
  .qbtn{display:none}
  .art{width:calc(100% - clamp(28px,5vmin,42px))}
  .art-ico{font-size:clamp(38px,5.5vmin,60px)}
}
@media(min-width:1400px){
  .pc{width:clamp(340px,28vw,460px)}
  .sb{width:clamp(250px,22vw,340px)}
  .ti-name{font-size:clamp(16px,2.2vmin,21px)}
}
@media(min-width:1800px){
  .app{padding:clamp(20px,3vh,52px)}
  .pc{width:clamp(360px,26vw,480px)}
  .sb{width:clamp(270px,20vw,360px)}
}

/* DESKTOP SIDEBAR */
.sb{
  display:none;flex-direction:column;
  width:clamp(230px,22vw,310px);
  background:rgba(12,12,24,.88);backdrop-filter:blur(40px);
  border:1px solid var(--border);border-radius:clamp(16px,2vmin,26px);
  overflow:hidden;
  box-shadow:0 0 0 1px rgba(255,255,255,.03) inset,0 20px 50px rgba(0,0,0,.5);
  align-self:stretch;
}
.sb-hd{padding:16px 13px 11px;border-bottom:1px solid var(--border);flex-shrink:0}
.sb-title{font-size:10px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:var(--A);margin-bottom:2px}
.sb-cnt{font-family:var(--ffm);font-size:9px;color:var(--di);letter-spacing:1px}
.sb-sc{flex:1;overflow-y:auto;padding:5px 9px;-webkit-overflow-scrolling:touch}
.sb-sc::-webkit-scrollbar{width:2px}
.sb-sc::-webkit-scrollbar-thumb{background:rgba(167,139,250,.28);border-radius:99px}
.sb-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;
  height:100%;gap:9px;color:var(--di);font-size:9px;letter-spacing:2px;text-transform:uppercase}
.sb-empty-ico{font-size:28px;opacity:.35}
/* Sidebar footer â€” mirrors queue footer */
.sb-footer{display:flex;gap:6px;margin:6px 9px 9px;flex-shrink:0}
.sb-foot-btn{
  flex:1;padding:9px 5px;
  border-radius:8px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;gap:5px;
  font-family:var(--ff);font-size:8px;font-weight:600;letter-spacing:1.5px;
  text-transform:uppercase;transition:all .18s;border:1px dashed;
}
.sb-foot-btn.add{background:rgba(167,139,250,.07);border-color:rgba(167,139,250,.24);color:rgba(167,139,250,.75)}
.sb-foot-btn.add:hover{background:rgba(167,139,250,.14);border-color:rgba(167,139,250,.45);color:var(--A)}
.sb-foot-btn.fld{background:rgba(56,189,248,.06);border-color:rgba(56,189,248,.22);color:rgba(56,189,248,.7)}
.sb-foot-btn.fld:hover{background:rgba(56,189,248,.13);border-color:rgba(56,189,248,.44);color:var(--A3)}

/* â”€â”€â”€ KEYFRAMES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@keyframes fl{0%,100%{transform:translateY(0)}50%{transform:translateY(-7px)}}
@keyframes pulse{0%,100%{opacity:.55;transform:scale(1)}50%{opacity:1;transform:scale(1.02)}}
@keyframes iw{0%,100%{transform:scaleY(.45);opacity:.35}50%{transform:scaleY(1.3);opacity:.8}}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.4}}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>

<!-- â”€â”€ BACKGROUND â”€â”€ -->
<div class="bg">
  <div class="grid"></div>
  <div class="orb o1"></div>
  <div class="orb o2"></div>
  <div class="orb o3"></div>
</div>

<!-- â•â• SPLASH â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="splash">
  <div class="sp-card">
    <div class="sp-ico">â™«</div>
    <div class="sp-logo">Aura</div>
    <div class="sp-h">Your Music, Offline</div>
    <div class="sp-p">
      Open a folder â€” AURA <em>auto-scans every audio file</em><br>
      recursively. No internet. No uploads.<br>Everything stays on your device.
    </div>
    <div class="sp-btns" id="spBtns">
      <button class="sp-main" id="spFolderBtn">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
        Open Music Folder
      </button>
      <button class="sp-sub" id="spFilesBtn">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        Pick Individual Files
      </button>
      <div class="sp-note">ğŸ”’ Files never leave your device</div>
    </div>
    <div class="sp-ld" id="spLoad">
      <div class="sp-ring"></div>
      <div class="sp-ltxt">Scanningâ€¦</div>
      <div class="sp-cnt" id="spCnt">Found 0 tracks</div>
    </div>
  </div>
</div>

<!-- â•â• APP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="app">

  <!-- PLAYER CARD -->
  <div class="pc" id="pc">

    <div class="hd">
      <div class="logo">Aura</div>
      <div class="fp" id="fp"><span class="fp-dot"></span><span id="fpName">Music</span></div>
      <button class="qbtn" id="qBtn">â‰¡ Queue</button>
    </div>

    <div class="art">
      <div class="art-bg"></div>
      <div class="art-ph">
        <div class="art-ico">â™«</div>
        <div class="art-hint" id="artHint">Open a folder to begin</div>
      </div>
      <div class="art-pulse"></div>
    </div>

    <!-- Track info: name first, then artist | folder -->
    <div class="ti">
      <div class="ti-name" id="tiName">No track loaded</div>
      <div class="ti-sub">
        <span class="ti-artist" id="tiArtist">Open a folder to begin</span>
        <span class="ti-sep" id="tiSep">|</span>
        <span class="ti-folder" id="tiFolder"></span>
      </div>
      <div class="ti-count" id="tiCount"></div>
    </div>

    <!-- Visualizer -->
    <div class="viz">
      <canvas id="vc"></canvas>
      <div class="viz-idle" id="vizIdle">
        <div class="ib"></div><div class="ib"></div><div class="ib"></div>
        <div class="ib"></div><div class="ib"></div><div class="ib"></div><div class="ib"></div>
      </div>
    </div>

    <!-- Progress -->
    <div class="prg">
      <div class="pt" id="pt"><div class="pf" id="pf"></div><div class="pt-th" id="pth"></div></div>
      <div class="times"><span id="tCur">0:00</span><span id="tDur">0:00</span></div>
    </div>

    <!-- Controls -->
    <div class="ctrl">
      <button class="cb btn-rpt" id="btnRpt" title="Repeat">
        <svg id="rptSvg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/>
          <polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/>
        </svg>
        <span class="rpt-badge" id="rptBadge"></span>
      </button>

      <button class="cb btn-pn" id="btnPrev">
        <svg width="19" height="19" viewBox="0 0 24 24" fill="currentColor">
          <polygon points="19 20 9 12 19 4 19 20"/>
          <line x1="5" y1="19" x2="5" y2="5" stroke="currentColor" stroke-width="2.5" fill="none" stroke-linecap="round"/>
        </svg>
      </button>

      <button class="cb btn-play" id="btnPlay">
        <svg id="icPlay" width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>
        <svg id="icPause" width="22" height="22" viewBox="0 0 24 24" fill="currentColor" style="display:none"><rect x="6" y="4" width="4" height="16" rx="1"/><rect x="14" y="4" width="4" height="16" rx="1"/></svg>
      </button>

      <button class="cb btn-pn" id="btnNext">
        <svg width="19" height="19" viewBox="0 0 24 24" fill="currentColor">
          <polygon points="5 4 15 12 5 20 5 4"/>
          <line x1="19" y1="5" x2="19" y2="19" stroke="currentColor" stroke-width="2.5" fill="none" stroke-linecap="round"/>
        </svg>
      </button>

      <button class="cb btn-fld" id="btnFolder" title="Open folder">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
      </button>
    </div>

    <!-- Hidden inputs -->
    <input type="file" id="fileInput" accept="audio/*" multiple style="display:none">
    <input type="file" id="folderInput" webkitdirectory accept="audio/*" multiple style="display:none">

    <!-- Volume -->
    <div class="vol">
      <button class="vol-mute" id="volMute">ğŸ”‰</button>
      <div style="display:flex;align-items:center;gap:8px;flex:1">
        <button class="vbtn" id="vMinus">âˆ’</button>
        <div class="vbar" id="vBar"><div class="vfill" id="vFill"></div></div>
        <button class="vbtn" id="vPlus">+</button>
      </div>
      <span class="vpct" id="vPct">80%</span>
    </div>

    <!-- Queue overlay -->
    <div class="qov" id="qov">
      <div class="qov-hd">
        <div><div class="qov-title">Queue</div><div class="qov-cnt" id="qovCnt">0 tracks</div></div>
        <button class="qov-x" id="qovClose">âœ•</button>
      </div>
      <div class="qsc" id="qsc">
        <div class="qempty" id="qEmpty"><div class="qempty-ico">ğŸµ</div><div>No tracks yet</div></div>
      </div>
      <div class="qfooter">
        <button class="qfoot-btn add" id="qAddFiles">
          <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Add Songs
        </button>
        <button class="qfoot-btn fld" id="qAddFolder">
          <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
          Folder
        </button>
      </div>
    </div>

  </div><!-- /.pc -->

  <!-- DESKTOP SIDEBAR -->
  <div class="sb" id="sb">
    <div class="sb-hd"><div class="sb-title">Queue</div><div class="sb-cnt" id="sbCnt">0 tracks</div></div>
    <div class="sb-sc" id="sbSc">
      <div class="sb-empty" id="sbEmpty"><div class="sb-empty-ico">ğŸµ</div><div>No tracks yet</div></div>
    </div>
    <div class="sb-footer">
      <button class="sb-foot-btn add" id="sbAddFiles">
        <svg width="9" height="9" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Add Songs
      </button>
      <button class="sb-foot-btn fld" id="sbAddFolder">
        <svg width="9" height="9" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
        Folder
      </button>
    </div>
  </div>

</div><!-- /.app -->

<audio id="audio" preload="metadata"></audio>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DEVTOOLS PROTECTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(function(){
  document.addEventListener('contextmenu',e=>e.preventDefault());
  document.addEventListener('keydown',e=>{
    if(e.key==='F12'){e.preventDefault();return false;}
    if((e.ctrlKey||e.metaKey)&&e.shiftKey&&'IJCijc'.includes(e.key)){e.preventDefault();return false;}
    if((e.ctrlKey||e.metaKey)&&'USus'.includes(e.key)){e.preventDefault();return false;}
  });
  let gone=false;
  setInterval(()=>{
    if(!gone&&(window.outerWidth-window.innerWidth>160||window.outerHeight-window.innerHeight>160)){
      gone=true;document.body.innerHTML='';document.body.style.background='#080810';
    }
  },1400);
  setInterval(new Function('debugger'),80);
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const S={
  songs:[],          /* {url,name,artist,folder,duration,_key} */
  cur:-1,
  playing:false,
  repeat:'none',     /* none | all | one | shuffle */
  vol:0.8,
  _prevVol:0.8,
  actx:null, analyser:null, src:null, animId:null,
  /* smooth viz state */
  smooth:[],         /* float array â€” persists between frames */
};
const EXTS=new Set(['mp3','wav','flac','ogg','m4a','aac','opus','wma','aiff','aif','mp4','webm','oga','caf']);
const RPT=['none','all','one','shuffle'];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DOM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const audio   = document.getElementById('audio');
const pc      = document.getElementById('pc');
const splash  = document.getElementById('splash');
const spBtns  = document.getElementById('spBtns');
const spLoad  = document.getElementById('spLoad');
const spCnt   = document.getElementById('spCnt');
const o1=document.querySelector('.o1'),o2=document.querySelector('.o2'),o3=document.querySelector('.o3');

const btnPlay  = document.getElementById('btnPlay');
const btnPrev  = document.getElementById('btnPrev');
const btnNext  = document.getElementById('btnNext');
const btnRpt   = document.getElementById('btnRpt');
const rptSvg   = document.getElementById('rptSvg');
const rptBadge = document.getElementById('rptBadge');
const icPlay   = document.getElementById('icPlay');
const icPause  = document.getElementById('icPause');

const tiName   = document.getElementById('tiName');
const tiArtist = document.getElementById('tiArtist');
const tiSep    = document.getElementById('tiSep');
const tiFolder = document.getElementById('tiFolder');
const tiCount  = document.getElementById('tiCount');
const artHint  = document.getElementById('artHint');

const pt   = document.getElementById('pt');
const pf   = document.getElementById('pf');
const pth  = document.getElementById('pth');
const tCur = document.getElementById('tCur');
const tDur = document.getElementById('tDur');

const qBtn    = document.getElementById('qBtn');
const qov     = document.getElementById('qov');
const qovCnt  = document.getElementById('qovCnt');
const qsc     = document.getElementById('qsc');
const qEmpty  = document.getElementById('qEmpty');
const sbCnt   = document.getElementById('sbCnt');
const sbSc    = document.getElementById('sbSc');
const sbEmpty = document.getElementById('sbEmpty');

const canvas  = document.getElementById('vc');
const vx      = canvas.getContext('2d');
const vizIdle = document.getElementById('vizIdle');

const fileInput   = document.getElementById('fileInput');
const folderInput = document.getElementById('folderInput');
const fp          = document.getElementById('fp');
const fpName      = document.getElementById('fpName');

const volMute = document.getElementById('volMute');
const vMinus  = document.getElementById('vMinus');
const vPlus   = document.getElementById('vPlus');
const vFill   = document.getElementById('vFill');
const vBar    = document.getElementById('vBar');
const vPct    = document.getElementById('vPct');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SESSION CACHE (#5 offline via localStorage)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const CK='aura_v3';
function saveCache(){
  try{
    localStorage.setItem(CK,JSON.stringify({
      idx:S.cur, t:audio.currentTime||0,
      vol:S.vol, rep:S.repeat,
      folder:fpName.textContent,
      names:S.songs.map(s=>s.name),
    }));
  }catch(_){}
}
function loadCache(){try{return JSON.parse(localStorage.getItem(CK));}catch{return null;}}
setInterval(saveCache,5000);
window.addEventListener('beforeunload',saveCache);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VOLUME â€” analogue +/- with hold
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let vt=null;
function setVol(v,save=true){
  S.vol=Math.max(0,Math.min(1,v));
  audio.volume=S.vol;
  vFill.style.width=(S.vol*100)+'%';
  vPct.textContent=Math.round(S.vol*100)+'%';
  volMute.textContent=S.vol===0?'ğŸ”‡':S.vol<0.4?'ğŸ”ˆ':S.vol<0.7?'ğŸ”‰':'ğŸ”Š';
  if(save) saveCache();
}
function holdV(d){vt=setInterval(()=>setVol(S.vol+d*.05),100);}
function stopV(){clearInterval(vt);}
vPlus.addEventListener('click',()=>setVol(S.vol+0.1));
vMinus.addEventListener('click',()=>setVol(S.vol-0.1));
vPlus.addEventListener('mousedown',()=>holdV(1));   vPlus.addEventListener('mouseup',stopV);   vPlus.addEventListener('mouseleave',stopV);
vMinus.addEventListener('mousedown',()=>holdV(-1)); vMinus.addEventListener('mouseup',stopV);  vMinus.addEventListener('mouseleave',stopV);
vPlus.addEventListener('touchstart',()=>holdV(1),{passive:true});  vPlus.addEventListener('touchend',stopV);
vMinus.addEventListener('touchstart',()=>holdV(-1),{passive:true}); vMinus.addEventListener('touchend',stopV);
vBar.addEventListener('click',e=>{const r=vBar.getBoundingClientRect();setVol((e.clientX-r.left)/r.width);});
volMute.addEventListener('click',()=>{ if(S.vol>0){S._prevVol=S.vol;setVol(0);}else setVol(S._prevVol||0.8); });
setVol(0.8,false);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DEDUPLICATION â€” by filename+size (#4)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function isDupe(file){
  const k=file.name+'|'+file.size;
  return S.songs.some(s=>s._key===k);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUTTON WIRING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.getElementById('spFolderBtn').addEventListener('click',openFolder);
document.getElementById('spFilesBtn').addEventListener('click',()=>fileInput.click());
document.getElementById('btnFolder').addEventListener('click',openFolder);
/* Queue overlay */
document.getElementById('qovClose').addEventListener('click',()=>{qov.classList.remove('open');qBtn.classList.remove('on');});
qBtn.addEventListener('click',()=>{qov.classList.toggle('open');qBtn.classList.toggle('on',qov.classList.contains('open'));});
document.getElementById('qAddFiles').addEventListener('click',()=>fileInput.click());
document.getElementById('qAddFolder').addEventListener('click',openFolder);
/* Sidebar */
document.getElementById('sbAddFiles').addEventListener('click',()=>fileInput.click());
document.getElementById('sbAddFolder').addEventListener('click',openFolder);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   OPEN FOLDER â€” FSA + fallbacks (#1,#5)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function openFolder(){
  if(window.showDirectoryPicker){
    try{
      const dir=await window.showDirectoryPicker({mode:'read'});
      showLoad();
      const entries=[];
      await scanDir(dir,entries,0,dir.name);
      if(!entries.length){hideLoad();alert('No audio files found.\nTry a different folder.');return;}
      entries.sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:true,sensitivity:'base'}));
      const fresh=entries.filter(e=>!isDupe(e.file)); /* dedupe (#4) */
      fpName.textContent=dir.name; fp.classList.add('on');
      if(!fresh.length){hideLoad();hideSplash();return;}
      await addToQueue(fresh);
    }catch(e){ if(e.name!=='AbortError') console.warn(e); hideLoad(); }
  }else{
    folderInput.click();
  }
}

/* Recursive scan â€” reads entire folder tree (#1) */
async function scanDir(dir,out,depth,folderLabel){
  if(depth>8) return;
  for await(const[name,entry] of dir.entries()){
    if(entry.kind==='file'){
      const ext=name.split('.').pop().toLowerCase();
      if(EXTS.has(ext)){
        try{
          const f=await entry.getFile();
          out.push({name,file:f,folder:folderLabel});
          spCnt.textContent=`Found ${out.length} track${out.length!==1?'s':''}`;
        }catch(_){}
      }
    }else if(entry.kind==='directory'){
      await scanDir(entry,out,depth+1,folderLabel);
    }
  }
}

/* webkitdirectory fallback */
folderInput.addEventListener('change',async e=>{
  const raw=[...e.target.files].filter(f=>EXTS.has(f.name.split('.').pop().toLowerCase()));
  folderInput.value='';
  if(!raw.length) return;
  showLoad();
  const label=raw[0].webkitRelativePath?raw[0].webkitRelativePath.split('/')[0]:'Music Folder';
  fpName.textContent=label; fp.classList.add('on');
  const entries=raw
    .filter(f=>!isDupe(f))
    .map(f=>({name:f.name,file:f,folder:label}))
    .sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:true,sensitivity:'base'}));
  if(!entries.length){hideLoad();hideSplash();return;}
  await addToQueue(entries);
});

/* Individual files â€” ACCUMULATES (#6), dedupes (#4) */
fileInput.addEventListener('change',async e=>{
  const raw=[...e.target.files].filter(f=>
    EXTS.has(f.name.split('.').pop().toLowerCase()) && !isDupe(f)
  );
  fileInput.value='';
  if(!raw.length) return;
  const entries=raw.map(f=>({name:f.name,file:f,folder:'My Files'}));
  await addToQueue(entries);
});

/* Drag & drop */
document.addEventListener('dragover',e=>e.preventDefault());
document.addEventListener('drop',async e=>{
  e.preventDefault(); showLoad();
  const items=[...e.dataTransfer.items];
  const entries=[];let label='Dropped';
  for(const item of items){
    if(item.kind!=='file') continue;
    if(item.getAsFileSystemHandle){
      try{
        const h=await item.getAsFileSystemHandle();
        if(h.kind==='directory'){label=h.name;await scanDir(h,entries,0,h.name);break;}
        else{const f=await h.getFile();entries.push({name:f.name,file:f,folder:label});}
      }catch{const f=item.getAsFile();if(f)entries.push({name:f.name,file:f,folder:label});}
    }else{const f=item.getAsFile();if(f)entries.push({name:f.name,file:f,folder:label});}
  }
  const af=entries.filter(e=>EXTS.has(e.name.split('.').pop().toLowerCase())&&!isDupe(e.file));
  if(!af.length){hideLoad();return;}
  af.sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:true,sensitivity:'base'}));
  fpName.textContent=label; fp.classList.add('on');
  await addToQueue(af);
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ADD TO QUEUE â€” appends, never replaces
   creates blob URLs + loads durations
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function addToQueue(entries){
  const startIdx=S.songs.length;
  /* Create song objects immediately so queue renders right away */
  const newSongs=entries.map(en=>{
    const nm=en.name.replace(/\.[^/.]+$/,'');
    return{
      url:URL.createObjectURL(en.file),
      file:en.file,
      name:nm,
      artist:en.folder||'Unknown',
      folder:en.folder||'',
      duration:'â€”',
      _key:en.file.name+'|'+en.file.size,
    };
  });
  S.songs.push(...newSongs);
  if(S.cur<0) S.cur=0; /* auto-select first track */
  renderAll();
  hideSplash();
  /* Load durations async */
  let done=0;
  await Promise.all(newSongs.map((song,i)=>new Promise(res=>{
    const t=new Audio(); t.preload='metadata'; t.src=song.url;
    const fin=()=>{
      if(t.duration&&!isNaN(t.duration)) S.songs[startIdx+i].duration=fmt(t.duration);
      spCnt.textContent=`Loading ${++done}/${newSongs.length}`;
      renderAll(); res();
    };
    t.addEventListener('loadedmetadata',fin,{once:true});
    t.addEventListener('error',fin,{once:true});
    setTimeout(fin,4000);
  })));
  /* Restore session position if first load matches cache */
  if(startIdx===0){
    const cache=loadCache();
    if(cache&&cache.names&&cache.names.length===S.songs.length&&cache.names[0]===S.songs[0].name){
      setVol(cache.vol||0.8,false);
      S.repeat=cache.rep||'none'; applyRepeatUI();
      const ri=Math.max(0,Math.min(cache.idx||0,S.songs.length-1));
      loadSong(ri,false);
      audio.addEventListener('loadedmetadata',()=>{
        if(cache.t>0) audio.currentTime=Math.min(cache.t,audio.duration||0);
      },{once:true});
    }else{
      loadSong(0,false);
    }
  }
  hideLoad();
  saveCache();
}

function showLoad(){spBtns.style.display='none';spLoad.classList.add('on');}
function hideLoad(){spBtns.style.display='';spLoad.classList.remove('on');}
function hideSplash(){splash.classList.add('gone');}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOAD SONG â€” name first, artist | folder
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function loadSong(idx,andPlay=false){
  if(idx<0||idx>=S.songs.length) return;
  S.cur=idx;
  const s=S.songs[idx];
  audio.src=s.url;
  /* #2: track name first */
  tiName.textContent=s.name;
  /* #2: sub-line = artist | folder */
  tiArtist.textContent=s.artist||'';
  const showSep=s.folder&&s.artist&&s.folder!==s.artist;
  tiSep.style.display=showSep?'inline':'none';
  tiFolder.textContent=showSep?s.folder:'';
  tiCount.textContent=`${idx+1} / ${S.songs.length}`;
  artHint.textContent=s.name;
  tDur.textContent='0:00'; tCur.textContent='0:00';
  pf.style.width='0%'; pth.style.left='0%';
  renderAll();
  if(andPlay||S.playing) audio.play().catch(()=>{});
  saveCache();
}
function playCurrent(){
  if(S.cur<0&&S.songs.length) S.cur=0;
  initACtx(); audio.play().catch(console.log);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUDIO CONTEXT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function initACtx(){
  if(S.actx) return;
  S.actx=new(window.AudioContext||window.webkitAudioContext)();
  S.analyser=S.actx.createAnalyser();
  /* High fftSize for smooth frequency resolution */
  S.analyser.fftSize=1024;
  S.analyser.smoothingTimeConstant=0.88;
  S.src=S.actx.createMediaElementSource(audio);
  S.src.connect(S.analyser);
  S.analyser.connect(S.actx.destination);
  /* Init smooth array */
  S.smooth=new Float32Array(S.analyser.frequencyBinCount).fill(0);
  startViz();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONTROLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
btnPlay.addEventListener('click',()=>{
  if(!S.songs.length){openFolder();return;}
  audio.paused?playCurrent():audio.pause();
});
btnPrev.addEventListener('click',()=>{
  if(!S.songs.length) return;
  if(audio.currentTime>3){audio.currentTime=0;return;}
  const was=S.playing; S.playing=true;
  loadSong(S.cur-1<0?S.songs.length-1:S.cur-1,was);
});
btnNext.addEventListener('click',()=>nextSong(false));

function nextSong(fromEnd=false){
  if(!S.songs.length) return;
  let idx;
  if(S.repeat==='one'&&fromEnd){audio.currentTime=0;audio.play();return;}
  else if(S.repeat==='shuffle'){
    if(S.songs.length===1){idx=0;}
    else do{idx=Math.floor(Math.random()*S.songs.length);}while(idx===S.cur);
  }else{
    idx=S.cur+1;
    if(idx>=S.songs.length){if(S.repeat==='all')idx=0;else{audio.pause();return;}}
  }
  const was=S.playing; S.playing=true;
  loadSong(idx,was||(fromEnd&&S.repeat!=='none'));
}

/* â”€â”€ Repeat â”€â”€ */
const RPT_SVG={
  none:`<polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/>`,
  all:`<polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/>`,
  one:`<polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/>`,
  shuffle:`<polyline points="16 3 21 3 21 8"/><line x1="4" y1="20" x2="21" y2="3"/><polyline points="21 16 21 21 16 21"/><line x1="15" y1="15" x2="21" y2="21"/>`
};
const RPT_LABEL={none:'',all:'ALL',one:'1',shuffle:'â†¯'};
function applyRepeatUI(){
  rptSvg.innerHTML=RPT_SVG[S.repeat];
  rptBadge.textContent=RPT_LABEL[S.repeat];
  btnRpt.className='cb btn-rpt';
  if(S.repeat!=='none') btnRpt.classList.add('s-'+S.repeat);
}
btnRpt.addEventListener('click',()=>{
  S.repeat=RPT[(RPT.indexOf(S.repeat)+1)%RPT.length];
  applyRepeatUI(); saveCache();
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUDIO EVENTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
audio.addEventListener('play',()=>{
  S.playing=true;
  icPlay.style.display='none'; icPause.style.display='block';
  pc.classList.add('playing');
  o1.classList.add('on'); o2.classList.add('on'); o3.classList.add('on');
  vizIdle.style.display='none';
  if(S.actx) S.actx.resume();
});
audio.addEventListener('pause',()=>{
  S.playing=false;
  icPlay.style.display='block'; icPause.style.display='none';
  pc.classList.remove('playing');
  o1.classList.remove('on'); o2.classList.remove('on'); o3.classList.remove('on');
  vizIdle.style.display='flex';
  saveCache();
});
audio.addEventListener('ended',()=>nextSong(true));
audio.addEventListener('loadedmetadata',()=>{
  tDur.textContent=fmt(audio.duration);
  if(S.cur>=0){S.songs[S.cur].duration=fmt(audio.duration);renderAll();}
});
audio.addEventListener('timeupdate',()=>{
  if(!audio.duration) return;
  const p=(audio.currentTime/audio.duration)*100;
  pf.style.width=p+'%'; pth.style.left=p+'%';
  tCur.textContent=fmt(audio.currentTime);
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SEEK
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let dragging=false;
function seekTo(cx){
  const r=pt.getBoundingClientRect();
  const p=Math.max(0,Math.min(1,(cx-r.left)/r.width));
  if(audio.duration) audio.currentTime=p*audio.duration;
}
pt.addEventListener('mousedown',e=>{dragging=true;pt.classList.add('drag');seekTo(e.clientX);});
document.addEventListener('mousemove',e=>{if(dragging)seekTo(e.clientX);});
document.addEventListener('mouseup',()=>{dragging=false;pt.classList.remove('drag');});
pt.addEventListener('touchstart',e=>{dragging=true;pt.classList.add('drag');seekTo(e.touches[0].clientX);},{passive:true});
document.addEventListener('touchmove',e=>{if(dragging&&e.touches[0])seekTo(e.touches[0].clientX);},{passive:true});
document.addEventListener('touchend',()=>{dragging=false;pt.classList.remove('drag');});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER QUEUE â€” overlay + sidebar
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderAll(){
  const n=S.songs.length;
  /* Overlay */
  qovCnt.textContent=`${n} track${n!==1?'s':''}`;
  qEmpty.style.display=n?'none':'flex';
  [...qsc.querySelectorAll('.row')].forEach(e=>e.remove());
  S.songs.forEach((s,i)=>{
    qsc.appendChild(mkRow(s,i,()=>{
      loadSong(i,true);
      qov.classList.remove('open'); qBtn.classList.remove('on');
    }));
  });
  /* Sidebar */
  sbCnt.textContent=`${n} track${n!==1?'s':''}`;
  sbEmpty.style.display=n?'none':'flex';
  [...sbSc.querySelectorAll('.row')].forEach(e=>e.remove());
  S.songs.forEach((s,i)=>{
    sbSc.appendChild(mkRow(s,i,()=>loadSong(i,true)));
  });
}

function mkRow(s,i,onclick){
  const d=document.createElement('div');
  d.className='row'+(i===S.cur?' on':'');
  d.innerHTML=`<div class="row-n">${i+1}</div><div class="row-pl">â–¶</div>
    <div class="row-ico">â™ª</div>
    <div class="row-meta">
      <div class="row-name">${esc(s.name)}</div>
      <div class="row-info">${esc(s.folder)} Â· ${s.duration}</div>
    </div>`;
  d.addEventListener('click',onclick);
  return d;
}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VISUALIZER â€” smooth beat-sync (#7)

   Algorithm:
   1. fftSize=1024 gives 512 frequency bins
   2. We use first ~200 bins (bass+mids = most musical)
   3. Per-bar exponential moving average (S.smooth[])
      creates lag-free but jitter-free response
   4. Bars grow symmetrically from canvas centre
   5. Colour shifts violetâ†’pinkâ†’cyan by position
   6. Glow caps appear on peaks
   7. Canvas resized with devicePixelRatio for crisp display
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const dpr=window.devicePixelRatio||1;
function resizeCanvas(){
  const wp=canvas.parentElement;
  canvas.width=wp.clientWidth*dpr;
  canvas.height=wp.clientHeight*dpr;
  canvas.style.width=wp.clientWidth+'px';
  canvas.style.height=wp.clientHeight+'px';
  vx.setTransform(dpr,0,0,dpr,0,0);
}
resizeCanvas();
const ro=new ResizeObserver(resizeCanvas);
ro.observe(canvas.parentElement);

function startViz(){
  if(S.animId) cancelAnimationFrame(S.animId);
  /* Reset smooth array to match new analyser size */
  S.smooth=new Float32Array(S.analyser.frequencyBinCount).fill(0);
  drawViz();
}

function drawViz(){
  S.animId=requestAnimationFrame(drawViz);
  if(!S.analyser) return;

  const W=canvas.parentElement.clientWidth;
  const H=canvas.parentElement.clientHeight;
  vx.clearRect(0,0,W,H);

  const bins=S.analyser.frequencyBinCount;
  const raw=new Uint8Array(bins);
  S.analyser.getByteFrequencyData(raw);

  /* â”€ Smooth each bin with exponential moving average â”€
     Attack fast (0.7), decay slow (0.12) = snappy rise, smooth fall
     This is what makes it match the audio precisely */
  const ATTACK=0.72, DECAY=0.14;
  for(let i=0;i<bins;i++){
    const v=raw[i]/255;
    S.smooth[i]=v>S.smooth[i]
      ? S.smooth[i]+(v-S.smooth[i])*ATTACK
      : S.smooth[i]+(v-S.smooth[i])*DECAY;
  }

  /* Use first 200 bins (~0â€“8kHz, most musical energy) */
  const N=Math.min(72, Math.floor(W/2/3)); /* bars per side, adapt to width */
  const gap=1.5;
  const bw=(W/2)/N;
  const cx=W/2;

  for(let i=0;i<N;i++){
    /* Average a small range of bins per bar for smoother distribution */
    const binStart=Math.floor(i*180/N);
    const binEnd=Math.min(bins-1,Math.floor((i+1)*180/N));
    let sum=0;
    for(let b=binStart;b<=binEnd;b++) sum+=S.smooth[b];
    const val=sum/(binEnd-binStart+1);

    const bh=Math.max(1.5,val*H*0.92);
    const t=i/N;

    /* Colour: violet â†’ pink â†’ cyan */
    let r,g,b;
    if(t<0.5){const u=t*2;r=lerp(167,244,u);g=lerp(139,114,u);b=lerp(250,182,u);}
    else{const u=(t-.5)*2;r=lerp(244,56,u);g=lerp(114,189,u);b=lerp(182,248,u);}
    const alpha=0.5+val*0.5;

    /* Right bar */
    const rx=cx+i*bw+gap*.5;
    const w=bw-gap;
    drawBar(rx,H,w,bh,r,g,b,alpha);

    /* Left bar (mirror) */
    const lx=cx-(i+1)*bw+gap*.5;
    drawBar(lx,H,w,bh,r,g,b,alpha);

    /* Peak glow dot */
    if(val>0.55){
      const dot=Math.min(w/2,2)+.8;
      vx.beginPath();
      vx.arc(rx+w/2,H-bh,dot,0,6.2832);
      vx.fillStyle=`rgba(${~~r},${~~g},${~~b},${val*.85})`;
      vx.fill();
      vx.beginPath();
      vx.arc(lx+w/2,H-bh,dot,0,6.2832);
      vx.fill();
    }
  }

  /* Subtle centre divider glow */
  const cg=vx.createLinearGradient(0,0,0,H);
  cg.addColorStop(0,'rgba(167,139,250,0)');
  cg.addColorStop(.45,'rgba(167,139,250,.28)');
  cg.addColorStop(1,'rgba(167,139,250,0)');
  vx.fillStyle=cg;
  vx.fillRect(cx-.75,0,1.5,H);
}

function drawBar(x,H,w,h,r,g,b,a){
  const col=`rgba(${~~r},${~~g},${~~b},${a})`;
  vx.fillStyle=col;
  const rad=Math.min(w/2,2.2);
  if(h>rad*2){
    vx.beginPath();
    vx.moveTo(x+rad,H-h); vx.lineTo(x+w-rad,H-h);
    vx.quadraticCurveTo(x+w,H-h,x+w,H-h+rad);
    vx.lineTo(x+w,H); vx.lineTo(x,H); vx.lineTo(x,H-h+rad);
    vx.quadraticCurveTo(x,H-h,x+rad,H-h);
    vx.closePath(); vx.fill();
  }else{vx.fillRect(x,H-h,w,h);}
  /* Soft ground reflection */
  if(h>3){
    const rg=vx.createLinearGradient(0,H,0,H+h*.22);
    rg.addColorStop(0,`rgba(${~~r},${~~g},${~~b},.10)`);
    rg.addColorStop(1,`rgba(${~~r},${~~g},${~~b},0)`);
    vx.fillStyle=rg; vx.fillRect(x,H,w,h*.22);
  }
}

function lerp(a,b,t){return a+(b-a)*t;}
function fmt(s){
  if(!s||isNaN(s)) return'0:00';
  return`${Math.floor(s/60)}:${String(Math.floor(s%60)).padStart(2,'0')}`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   KEYBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('keydown',e=>{
  if(['INPUT','TEXTAREA'].includes(e.target.tagName)) return;
  if(e.code==='Space'&&!e.ctrlKey){e.preventDefault();btnPlay.click();}
  else if(e.code==='ArrowRight'&&!e.ctrlKey) btnNext.click();
  else if(e.code==='ArrowLeft'&&!e.ctrlKey)  btnPrev.click();
  else if(e.code==='ArrowUp'&&!e.ctrlKey)    setVol(S.vol+0.1);
  else if(e.code==='ArrowDown'&&!e.ctrlKey)  setVol(S.vol-0.1);
  else if(e.code==='KeyR')                   btnRpt.click();
});
</script>
</body>
</html>
